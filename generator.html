<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Cache buster: updated to fix sizeControls error -->
    <title>GameInvitation –ö–∞—Ä—É—Å–µ–ª—å</title>
    <link rel="stylesheet" href="styles.css">
    <script>
        let projectsData = [];
        let currentProjectId = null;
        
        // –°–∏—Å—Ç–µ–º–∞ –æ—Ç–º–µ–Ω—ã/–ø–æ–≤—Ç–æ—Ä–∞
        let undoStack = [];
        let redoStack = [];
        const MAX_UNDO_STEPS = 50;
        
        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è –æ—Ç–º–µ–Ω—ã
        function saveStateForUndo() {
            const state = {
                projectsData: JSON.parse(JSON.stringify(projectsData)),
                currentProjectId: currentProjectId,
                slideImages: JSON.parse(JSON.stringify(slideImages)),
                imageSizes: JSON.parse(JSON.stringify(imageSizes)),
                imageGaps: JSON.parse(JSON.stringify(imageGaps)),
                containerSettings: JSON.parse(JSON.stringify(containerSettings)),
                logoSettings: JSON.parse(JSON.stringify(logoSettings)),
                timestamp: Date.now()
            };
            
            undoStack.push(state);
            if (undoStack.length > MAX_UNDO_STEPS) {
                undoStack.shift();
            }
            redoStack = []; // –û—á–∏—â–∞–µ–º —Å—Ç–µ–∫ –ø–æ–≤—Ç–æ—Ä–∞ –ø—Ä–∏ –Ω–æ–≤–æ–º –¥–µ–π—Å—Ç–≤–∏–∏
        }
        
        // –û—Ç–º–µ–Ω–∞ (cmd+z)
        function undo() {
            if (undoStack.length === 0) {
                showNotification('–ù–µ—Ç –¥–µ–π—Å—Ç–≤–∏–π –¥–ª—è –æ—Ç–º–µ–Ω—ã', 'info');
                return;
            }
            
            const currentState = {
                projectsData: JSON.parse(JSON.stringify(projectsData)),
                currentProjectId: currentProjectId,
                slideImages: JSON.parse(JSON.stringify(slideImages)),
                imageSizes: JSON.parse(JSON.stringify(imageSizes)),
                timestamp: Date.now()
            };
            
            redoStack.push(currentState);
            if (redoStack.length > MAX_UNDO_STEPS) {
                redoStack.shift();
            }
            
            const previousState = undoStack.pop();
            restoreState(previousState);
            showNotification('–û—Ç–º–µ–Ω–µ–Ω–æ', 'success');
        }
        
        // –ü–æ–≤—Ç–æ—Ä (cmd+shift+z)
        function redo() {
            if (redoStack.length === 0) {
                showNotification('–ù–µ—Ç –¥–µ–π—Å—Ç–≤–∏–π –¥–ª—è –ø–æ–≤—Ç–æ—Ä–∞', 'info');
                return;
            }
            
            const currentState = {
                projectsData: JSON.parse(JSON.stringify(projectsData)),
                currentProjectId: currentProjectId,
                slideImages: JSON.parse(JSON.stringify(slideImages)),
                imageSizes: JSON.parse(JSON.stringify(imageSizes)),
                imageGaps: JSON.parse(JSON.stringify(imageGaps)),
                containerSettings: JSON.parse(JSON.stringify(containerSettings)),
                logoSettings: JSON.parse(JSON.stringify(logoSettings)),
                timestamp: Date.now()
            };
            
            undoStack.push(currentState);
            if (undoStack.length > MAX_UNDO_STEPS) {
                undoStack.shift();
            }
            
            const nextState = redoStack.pop();
            restoreState(nextState);
            showNotification('–ü–æ–≤—Ç–æ—Ä–µ–Ω–æ', 'success');
        }
        
        // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è
        function restoreState(state) {
            projectsData = JSON.parse(JSON.stringify(state.projectsData));
            currentProjectId = state.currentProjectId;
            slideImages = JSON.parse(JSON.stringify(state.slideImages));
            imageSizes = JSON.parse(JSON.stringify(state.imageSizes));
            imageGaps = state.imageGaps ? JSON.parse(JSON.stringify(state.imageGaps)) : {};
            containerSettings = state.containerSettings ? JSON.parse(JSON.stringify(state.containerSettings)) : {};
            logoSettings = state.logoSettings ? JSON.parse(JSON.stringify(state.logoSettings)) : {};
            
            if (currentProjectId) {
                const project = projectsData.find(p => p.id === currentProjectId);
                if (project) {
                    generateSlides(project);
                    renderProjectsList();
                }
            }
        }
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≥–æ—Ä—è—á–∏—Ö –∫–ª–∞–≤–∏—à
        document.addEventListener('keydown', (e) => {
            // cmd+z –∏–ª–∏ ctrl+z –¥–ª—è –æ—Ç–º–µ–Ω—ã
            if ((e.metaKey || e.ctrlKey) && e.key === 'z' && !e.shiftKey) {
                e.preventDefault();
                undo();
            }
            // cmd+shift+z –∏–ª–∏ ctrl+shift+z –¥–ª—è –ø–æ–≤—Ç–æ—Ä–∞
            if ((e.metaKey || e.ctrlKey) && e.key === 'z' && e.shiftKey) {
                e.preventDefault();
                redo();
            }
        });
        
        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å localStorage
        function saveToLocalStorage() {
            try {
                localStorage.setItem('slideGenerator_projectsData', JSON.stringify(projectsData));
                localStorage.setItem('slideGenerator_currentProjectId', currentProjectId || '');
                localStorage.setItem('slideImages', JSON.stringify(slideImages));
                localStorage.setItem('imageSizes', JSON.stringify(imageSizes));
                localStorage.setItem('imageGaps', JSON.stringify(imageGaps));
                localStorage.setItem('containerSettings', JSON.stringify(containerSettings));
                localStorage.setItem('logoSettings', JSON.stringify(logoSettings));
            } catch (e) {
                // –ï—Å–ª–∏ localStorage –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω, –ø—ã—Ç–∞–µ–º—Å—è –æ—á–∏—Å—Ç–∏—Ç—å —Å—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ
                if (e.name === 'QuotaExceededError') {
                    console.warn('localStorage –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω, –æ—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ...');
                    try {
                        // –û—á–∏—â–∞–µ–º —Ç–æ–ª—å–∫–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è, —Å–æ—Ö—Ä–∞–Ω—è—è –æ—Å—Ç–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
                        const oldSlideImages = slideImages;
                        slideImages = {};
                        localStorage.setItem('slideGenerator_projectsData', JSON.stringify(projectsData));
                        localStorage.setItem('slideGenerator_currentProjectId', currentProjectId || '');
                        localStorage.setItem('imageSizes', JSON.stringify(imageSizes));
                        localStorage.setItem('imageGaps', JSON.stringify(imageGaps));
                        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º slideImages –≤ –ø–∞–º—è—Ç–∏
                        slideImages = oldSlideImages;
                        showNotification('–î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã (–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –Ω–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –∏–∑-–∑–∞ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π –±—Ä–∞—É–∑–µ—Ä–∞)', 'warning');
                    } catch (e2) {
                        console.error('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –¥–∞–∂–µ –±–µ–∑ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π:', e2);
                        showNotification('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–µ. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —ç–∫—Å–ø–æ—Ä—Ç JSON.', 'error');
                    }
                } else {
                    console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ localStorage:', e);
                }
            }
        }
        
        function loadFromLocalStorage() {
            try {
                const savedProjects = localStorage.getItem('slideGenerator_projectsData');
                if (savedProjects) {
                    projectsData = JSON.parse(savedProjects);
                }
                
                const savedProjectId = localStorage.getItem('slideGenerator_currentProjectId');
                if (savedProjectId) {
                    currentProjectId = savedProjectId;
                }
                
                const savedSlideImages = localStorage.getItem('slideImages');
                if (savedSlideImages) {
                    slideImages = JSON.parse(savedSlideImages);
                }
                
                const savedImageSizes = localStorage.getItem('imageSizes');
                if (savedImageSizes) {
                    imageSizes = JSON.parse(savedImageSizes);
                }
                
                const savedImageGaps = localStorage.getItem('imageGaps');
                if (savedImageGaps) {
                    imageGaps = JSON.parse(savedImageGaps);
                }
                
                const savedContainerSettings = localStorage.getItem('containerSettings');
                if (savedContainerSettings) {
                    containerSettings = JSON.parse(savedContainerSettings);
                }
                
                const savedLogoSettings = localStorage.getItem('logoSettings');
                if (savedLogoSettings) {
                    logoSettings = JSON.parse(savedLogoSettings);
                }
            } catch (e) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑ localStorage:', e);
            }
        }
        
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö
        function autoSave() {
            saveToLocalStorage();
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ –∫—Ä–∞—Å–∏–≤—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
        function showNotification(message, type = 'success', duration = 3000) {
            // –£–¥–∞–ª—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
            const existing = document.querySelectorAll('.custom-notification');
            existing.forEach(n => n.remove());
            
            const notification = document.createElement('div');
            notification.className = `custom-notification custom-notification-${type}`;
            
            const icon = type === 'success' ? '‚úì' : type === 'error' ? '‚úï' : type === 'warning' ? '‚ö†' : '‚Ñπ';
            notification.innerHTML = `
                <div class="notification-icon">${icon}</div>
                <div class="notification-message">${message}</div>
                <button class="notification-close">√ó</button>
            `;
            
            document.body.appendChild(notification);
            
            // –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è
            setTimeout(() => {
                notification.classList.add('show');
            }, 10);
            
            // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ –∫–ª–∏–∫—É
            notification.querySelector('.notification-close').addEventListener('click', () => {
                closeNotification(notification);
            });
            
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ
            if (duration > 0) {
                setTimeout(() => {
                    closeNotification(notification);
                }, duration);
            }
        }
        
        function closeNotification(notification) {
            notification.classList.remove('show');
            setTimeout(() => {
                notification.remove();
            }, 300);
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Ñ–æ–Ω–∞ —Å–ª–∞–π–¥–∞
        function createBackgroundStyle(background) {
            if (background.type === 'gradient') {
                return `linear-gradient(${background.direction}deg, ${background.colors.join(', ')})`;
            } else {
                return background.colors[0];
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Å–ª–∞–π–¥–∞ –∏–∑ JSON
        function createSlideFromJSON(slideData, slideIndex, totalSlides, logo, watermark) {
            const slide = document.createElement('div');
            slide.className = `slide slide-${slideData.id}`;
            slide.style.background = createBackgroundStyle(slideData.background);
            
            // –õ–æ–≥–æ—Ç–∏–ø
            if (logo) {
                const logoImg = document.createElement('img');
                logoImg.src = logo;
                logoImg.alt = 'Logo';
                logoImg.className = 'logo';
                logoImg.style.cursor = 'pointer';
                logoImg.title = '–ö–ª–∏–∫–Ω–∏—Ç–µ –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ª–æ–≥–æ—Ç–∏–ø–∞';
                
                // –ü—Ä–∏–º–µ–Ω—è–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ª–æ–≥–æ—Ç–∏–ø–∞
                const projectId = projectsData.find(p => p.logo === logo)?.id || currentProjectId;
                if (projectId && logoSettings[projectId]) {
                    const settings = logoSettings[projectId];
                    if (settings.height) logoImg.style.height = settings.height + 'px';
                    if (settings.top !== undefined) logoImg.style.top = settings.top + 'px';
                    if (settings.left !== undefined) logoImg.style.left = settings.left + 'px';
                    if (settings.opacity !== undefined) logoImg.style.opacity = settings.opacity;
                    if (settings.shadow) logoImg.style.filter = `drop-shadow(${settings.shadow})`;
                    if (settings.border && settings.borderWidth > 0) {
                        logoImg.style.border = `${settings.borderWidth}px solid ${settings.borderColor || '#ffffff'}`;
                        logoImg.style.borderRadius = (settings.borderRadius || 0) + 'px';
                    }
                }
                
                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –ø–∞–Ω–µ–ª–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫
                logoImg.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const projectId = projectsData.find(p => p.logo === logo)?.id || currentProjectId;
                    if (projectId) {
                        showLogoSettingsPanel(projectId);
                    }
                });
                
                slide.appendChild(logoImg);
            }
            
            // –ù–æ–º–µ—Ä —Å–ª–∞–π–¥–∞
            const slideNumber = document.createElement('div');
            slideNumber.className = 'slide-number';
            slideNumber.textContent = `${slideData.id}/${totalSlides}`;
            slide.appendChild(slideNumber);
            
            // –≠–º–æ–¥–∂–∏
            if (slideData.emoji) {
                const emoji = document.createElement('span');
                emoji.className = 'emoji';
                emoji.textContent = slideData.emoji;
                slide.appendChild(emoji);
            }
            
            // –ó–∞–≥–æ–ª–æ–≤–æ–∫
            if (slideData.title) {
                const title = document.createElement(slideData.title.tag || 'h2');
                title.innerHTML = slideData.title.text.replace(/\n/g, '<br>');
                title.className = 'editable-text';
                title.dataset.textType = 'title';
                
                // –ü—Ä–∏–º–µ–Ω—è–µ–º —Å—Ç–∏–ª–∏ –∏–∑ JSON
                if (slideData.title.style) {
                    if (slideData.title.style.fontFamily) {
                        title.style.fontFamily = slideData.title.style.fontFamily;
                    } else {
                        title.style.fontFamily = "'Comfortaa', cursive";
                    }
                    if (slideData.title.style.fontSize) {
                        title.style.fontSize = slideData.title.style.fontSize;
                    }
                    if (slideData.title.style.textAlign) {
                        title.style.textAlign = slideData.title.style.textAlign;
                    }
                    if (slideData.title.style.color) {
                        // –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ —Ü–≤–µ—Ç –≤ HEX —Ñ–æ—Ä–º–∞—Ç–µ
                        let color = slideData.title.style.color;
                        if (color.startsWith('rgb')) {
                            const matches = color.match(/\d+/g);
                            if (matches && matches.length >= 3) {
                                color = '#' + matches.map(x => {
                                    const hex = parseInt(x).toString(16);
                                    return hex.length === 1 ? '0' + hex : hex;
                                }).join('');
                            }
                        }
                        title.style.color = color;
                    } else {
                        title.style.color = '#ffffff';
                    }
                } else {
                    title.style.fontFamily = "'Comfortaa', cursive";
                    title.style.color = '#ffffff';
                }
                
                slide.appendChild(title);
            }
            
            // –ü–æ–¥–∑–∞–≥–æ–ª–æ–≤–æ–∫
            if (slideData.subtitle && slideData.subtitle.text) {
                const subtitle = document.createElement('div');
                subtitle.className = 'subtitle editable-text';
                subtitle.dataset.textType = 'subtitle';
                subtitle.innerHTML = slideData.subtitle.text.replace(/\n/g, '<br>');
                
                // –ü—Ä–∏–º–µ–Ω—è–µ–º —Å—Ç–∏–ª–∏ –∏–∑ JSON
                if (slideData.subtitle.style) {
                    if (slideData.subtitle.style.fontFamily) {
                        subtitle.style.fontFamily = slideData.subtitle.style.fontFamily;
                    } else {
                        subtitle.style.fontFamily = "'Comfortaa', cursive";
                    }
                    if (slideData.subtitle.style.fontSize) {
                        subtitle.style.fontSize = slideData.subtitle.style.fontSize;
                    }
                    if (slideData.subtitle.style.textAlign) {
                        subtitle.style.textAlign = slideData.subtitle.style.textAlign;
                    }
                    if (slideData.subtitle.style.color) {
                        // –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ —Ü–≤–µ—Ç –≤ HEX —Ñ–æ—Ä–º–∞—Ç–µ
                        let color = slideData.subtitle.style.color;
                        if (color.startsWith('rgb')) {
                            const matches = color.match(/\d+/g);
                            if (matches && matches.length >= 3) {
                                color = '#' + matches.map(x => {
                                    const hex = parseInt(x).toString(16);
                                    return hex.length === 1 ? '0' + hex : hex;
                                }).join('');
                            }
                        }
                        subtitle.style.color = color;
                    } else {
                        subtitle.style.color = '#ffffff';
                    }
                } else {
                    subtitle.style.fontFamily = "'Comfortaa', cursive";
                }
                
                slide.appendChild(subtitle);
            }
            
            // –ü–∞—Ä–∞–≥—Ä–∞—Ñ
            if (slideData.paragraph && slideData.paragraph.text) {
                const paragraph = document.createElement('p');
                paragraph.className = 'editable-text';
                paragraph.dataset.textType = 'paragraph';
                paragraph.innerHTML = slideData.paragraph.text.replace(/\n/g, '<br>');
                
                // –ü—Ä–∏–º–µ–Ω—è–µ–º —Å—Ç–∏–ª–∏ –∏–∑ JSON
                if (slideData.paragraph.style) {
                    if (slideData.paragraph.style.fontFamily) {
                        paragraph.style.fontFamily = slideData.paragraph.style.fontFamily;
                    } else {
                        paragraph.style.fontFamily = "'Comfortaa', cursive";
                    }
                    if (slideData.paragraph.style.fontSize) {
                        paragraph.style.fontSize = slideData.paragraph.style.fontSize;
                    }
                    if (slideData.paragraph.style.textAlign) {
                        paragraph.style.textAlign = slideData.paragraph.style.textAlign;
                    }
                    if (slideData.paragraph.style.color) {
                        // –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ —Ü–≤–µ—Ç –≤ HEX —Ñ–æ—Ä–º–∞—Ç–µ
                        let color = slideData.paragraph.style.color;
                        if (color.startsWith('rgb')) {
                            const matches = color.match(/\d+/g);
                            if (matches && matches.length >= 3) {
                                color = '#' + matches.map(x => {
                                    const hex = parseInt(x).toString(16);
                                    return hex.length === 1 ? '0' + hex : hex;
                                }).join('');
                            }
                        }
                        paragraph.style.color = color;
                    } else {
                        paragraph.style.color = '#ffffff';
                    }
                } else {
                    paragraph.style.fontFamily = "'Comfortaa', cursive";
                    paragraph.style.color = '#ffffff';
                }
                
                slide.appendChild(paragraph);
            }
            
            // –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
            if (slideData.images && slideData.images.length > 0) {
                if (slideData.images.length === 1) {
                    // –î–æ–±–∞–≤–ª—è–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å –∫–æ–Ω—Ç—Ä–æ–ª–∞–º–∏ (–∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ)
                    const imgData = slideData.images[0];
                    addImageWithControls(slide, imgData.src, imgData.alt || '', slideIndex, imgData.size || null);
                } else {
                    const container = document.createElement('div');
                    container.className = 'slide-image-container';
                    container.dataset.slideIndex = slideIndex;
                    // –ü—Ä–∏–º–µ–Ω—è–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π gap –µ—Å–ª–∏ –µ—Å—Ç—å
                    const gapKey = `gap_${slideIndex}`;
                    const savedGap = imageGaps[gapKey] || 15;
                    container.style.gap = savedGap + 'px';
                    slideData.images.forEach(imgData => {
                        addImageWithControls(container, imgData.src, imgData.alt || '', slideIndex, imgData.size || null);
                    });
                    slide.appendChild(container);
                }
            }
            
            // CTA
            if (slideData.cta && slideData.cta.text) {
                const cta = document.createElement('div');
                cta.className = 'cta';
                cta.textContent = slideData.cta.text;
                if (slideData.cta.color) {
                    cta.style.color = slideData.cta.color;
                }
                slide.appendChild(cta);
            }
            
            // –í–æ–¥—è–Ω–æ–π –∑–Ω–∞–∫
            if (watermark) {
                slide.setAttribute('data-watermark', watermark);
            }
            
            return slide;
        }
        
        // –•—Ä–∞–Ω–∏–ª–∏—â–µ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Å–ª–∞–π–¥–∞
        let slideImages = {};
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –≤ –ø–∞–Ω–µ–ª–∏
        function updateImagePreview(preview, slideIndex, slideElement, additionalSlides) {
            preview.innerHTML = '';
            
            // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å–æ —Å–ª–∞–π–¥–∞
            const allImages = slideElement.querySelectorAll('.slide-image-container img, .uploaded-image-wrapper img');
            const imageList = document.createElement('div');
            imageList.className = 'image-list';
            imageList.style.display = 'flex';
            imageList.style.flexDirection = 'column';
            imageList.style.gap = '10px';
            imageList.style.maxHeight = '300px';
            imageList.style.overflowY = 'auto';
            
            if (allImages.length === 0) {
                const emptyMsg = document.createElement('div');
                emptyMsg.textContent = '–ù–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π';
                emptyMsg.style.color = '#999';
                emptyMsg.style.textAlign = 'center';
                emptyMsg.style.padding = '20px';
                imageList.appendChild(emptyMsg);
            } else {
                allImages.forEach((img, idx) => {
                    const imageItem = document.createElement('div');
                    imageItem.className = 'image-item';
                    imageItem.style.display = 'flex';
                    imageItem.style.alignItems = 'center';
                    imageItem.style.gap = '10px';
                    imageItem.style.padding = '8px';
                    imageItem.style.background = 'rgba(255, 255, 255, 0.05)';
                    imageItem.style.borderRadius = '8px';
                    
                    const imgPreview = document.createElement('img');
                    imgPreview.src = img.src;
                    imgPreview.style.width = '60px';
                    imgPreview.style.height = '60px';
                    imgPreview.style.objectFit = 'cover';
                    imgPreview.style.borderRadius = '4px';
                    
                    const deleteBtn = document.createElement('button');
                    deleteBtn.textContent = '√ó';
                    deleteBtn.style.background = '#ef4444';
                    deleteBtn.style.color = 'white';
                    deleteBtn.style.border = 'none';
                    deleteBtn.style.borderRadius = '4px';
                    deleteBtn.style.width = '24px';
                    deleteBtn.style.height = '24px';
                    deleteBtn.style.cursor = 'pointer';
                    deleteBtn.style.flexShrink = '0';
                    deleteBtn.title = '–£–¥–∞–ª–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ';
                    
                    deleteBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        saveStateForUndo();
                        
                        // –ù–∞—Ö–æ–¥–∏–º sizeKey –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
                        const sizeKey = img.dataset.sizeKey;
                        const imageWrapper = img.closest('.uploaded-image-wrapper');
                        
                        // –£–¥–∞–ª—è–µ–º –∏–∑ –≤—Å–µ—Ö —Å–ª–∞–π–¥–æ–≤
                        const allSlides = document.querySelectorAll('.slide');
                        allSlides.forEach(slide => {
                            const relatedImg = slide.querySelector(`img[data-size-key="${sizeKey}"]`);
                            if (relatedImg) {
                                relatedImg.closest('.uploaded-image-wrapper')?.remove();
                            }
                        });
                        
                        // –£–¥–∞–ª—è–µ–º –∏–∑ slideImages
                        if (slideImages[slideIndex]) {
                            const imgSrc = img.src;
                            slideImages[slideIndex] = slideImages[slideIndex].filter(imgData => imgData !== imgSrc);
                            if (slideImages[slideIndex].length === 0) {
                                delete slideImages[slideIndex];
                            }
                        }
                        
                        // –£–¥–∞–ª—è–µ–º —Ä–∞–∑–º–µ—Ä
                        if (sizeKey) {
                            delete imageSizes[sizeKey];
                        }
                        
                        saveToLocalStorage();
                        updateImagePreview(preview, slideIndex, slideElement, additionalSlides);
                    });
                    
                    imageItem.appendChild(imgPreview);
                    imageItem.appendChild(deleteBtn);
                    imageList.appendChild(imageItem);
                });
            }
            
            preview.appendChild(imageList);
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∫–Ω–æ–ø–∫–∏ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
        function createImageUploadButton(slideIndex, slideElement, additionalSlides = []) {
            const wrapper = document.createElement('div');
            wrapper.className = 'slide-image-upload-wrapper';
            wrapper.dataset.slideIndex = slideIndex;
            
            const header = document.createElement('div');
            header.style.display = 'flex';
            header.style.gap = '10px';
            header.style.marginBottom = '10px';
            
            const uploadBtn = document.createElement('button');
            uploadBtn.className = 'image-upload-btn';
            uploadBtn.textContent = 'üì∑ –ó–∞–≥—Ä—É–∑–∏—Ç—å';
            uploadBtn.type = 'button';
            uploadBtn.style.flex = '1';
            
            const settingsBtn = document.createElement('button');
            settingsBtn.className = 'image-settings-btn';
            settingsBtn.textContent = '‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏';
            settingsBtn.type = 'button';
            settingsBtn.title = '–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π';
            
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = 'image/*';
            fileInput.style.display = 'none';
            fileInput.multiple = true; // –†–∞–∑—Ä–µ—à–∞–µ–º –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–π –≤—ã–±–æ—Ä
            
            const preview = document.createElement('div');
            preview.className = 'image-preview';
            
            // –ï—Å–ª–∏ –µ—Å—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∏—Ö –∏ –¥–æ–±–∞–≤–ª—è–µ–º –≤ —Å–ª–∞–π–¥
            if (slideImages[slideIndex]) {
                const images = Array.isArray(slideImages[slideIndex]) ? slideImages[slideIndex] : [slideImages[slideIndex]];
                images.forEach((imgData) => {
                    addImageToSlide(slideElement, imgData, slideIndex);
                    additionalSlides.forEach(slide => {
                        addImageToSlide(slide, imgData, slideIndex);
                    });
                });
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º preview –ø–æ—Å–ª–µ –Ω–µ–±–æ–ª—å—à–æ–π –∑–∞–¥–µ—Ä–∂–∫–∏, —á—Ç–æ–±—ã –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —É—Å–ø–µ–ª–∏ –¥–æ–±–∞–≤–∏—Ç—å—Å—è
            setTimeout(() => {
                updateImagePreview(preview, slideIndex, slideElement, additionalSlides);
            }, 100);
            
            uploadBtn.addEventListener('click', () => {
                fileInput.click();
            });
            
            fileInput.addEventListener('change', async (e) => {
                const files = Array.from(e.target.files);
                if (files.length === 0) return;
                
                saveStateForUndo();
                
                for (const file of files) {
                    const reader = new FileReader();
                    await new Promise((resolve) => {
                        reader.onload = async (event) => {
                            const imageData = event.target.result; // base64
                            
                            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ (–º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ)
                            if (!slideImages[slideIndex]) {
                                slideImages[slideIndex] = [];
                            }
                            if (!Array.isArray(slideImages[slideIndex])) {
                                slideImages[slideIndex] = [slideImages[slideIndex]];
                            }
                            slideImages[slideIndex].push(imageData);
                            
                            // –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è –≤—ã—á–∏—Å–ª–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞
                            const tempImg = new Image();
                            tempImg.src = imageData;
                            
                            // –í—ã—á–∏—Å–ª—è–µ–º –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä –¥–ª—è –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Å–ª–∞–π–¥–∞
                            const optimalSize = await calculateOptimalImageSize(tempImg, slideElement);
                            const sizeKey = `${slideIndex}_${imageData.substring(0, 50)}`;
                            imageSizes[sizeKey] = optimalSize;
                            
                            // –î–æ–±–∞–≤–ª—è–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤ –æ—Å–Ω–æ–≤–Ω–æ–π —Å–ª–∞–π–¥ —Å –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–º —Ä–∞–∑–º–µ—Ä–æ–º
                            addImageToSlide(slideElement, imageData, slideIndex, false, optimalSize);
                            
                            // –î–æ–±–∞–≤–ª—è–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤–æ –≤—Å–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å–ª–∞–π–¥—ã (–¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —Ñ–æ—Ä–º–∞—Ç–æ–≤)
                            additionalSlides.forEach(slide => {
                                addImageToSlide(slide, imageData, slideIndex, false, optimalSize);
                            });
                            
                            resolve();
                        };
                        reader.readAsDataURL(file);
                    });
                }
                
                saveToLocalStorage();
                updateImagePreview(preview, slideIndex, slideElement, additionalSlides);
                fileInput.value = ''; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º input
            });
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫
            settingsBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                const container = slideElement.querySelector('.slide-image-container');
                if (container) {
                    showContainerSettingsPanel(container, slideIndex);
                } else {
                    showNotification('–°–Ω–∞—á–∞–ª–∞ –¥–æ–±–∞–≤—å—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–∞ —Å–ª–∞–π–¥', 'info');
                }
            });
            
            header.appendChild(uploadBtn);
            header.appendChild(settingsBtn);
            wrapper.appendChild(header);
            wrapper.appendChild(fileInput);
            wrapper.appendChild(preview);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º preview –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö –Ω–∞ —Å–ª–∞–π–¥–µ
            const observer = new MutationObserver(() => {
                updateImagePreview(preview, slideIndex, slideElement, additionalSlides);
            });
            observer.observe(slideElement, { childList: true, subtree: true });
            
            return wrapper;
        }
        
        // –•—Ä–∞–Ω–∏–ª–∏—â–µ —Ä–∞–∑–º–µ—Ä–æ–≤ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
        let imageSizes = {};
        let imageGaps = {}; // –•—Ä–∞–Ω–∏–ª–∏—â–µ –æ—Ç—Å—Ç—É–ø–æ–≤ –º–µ–∂–¥—É –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Å–ª–∞–π–¥–∞
        let containerSettings = {}; // –•—Ä–∞–Ω–∏–ª–∏—â–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π (–æ—Ç—Å—Ç—É–ø—ã, –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ, –æ–∫—Ä—É–≥–ª–µ–Ω–∏–µ)
        let logoSettings = {}; // –•—Ä–∞–Ω–∏–ª–∏—â–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –ª–æ–≥–æ—Ç–∏–ø–∞ (—Ä–∞–∑–º–µ—Ä, –ø–æ–∑–∏—Ü–∏—è, –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å, —Ç–µ–Ω—å, –æ–±–≤–æ–¥–∫–∞)
        let selectedImage = null; // –í—ã–±—Ä–∞–Ω–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–æ–º
        let selectedImageContainer = null; // –í—ã–±—Ä–∞–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –æ—Ç—Å—Ç—É–ø–∞–º–∏
        let selectedTextElement = null; // –í—ã–±—Ä–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç–æ–≤—ã–π —ç–ª–µ–º–µ–Ω—Ç –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ø–∞–Ω–µ–ª–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–æ–º (–≤–Ω–µ —Å–ª–∞–π–¥–∞)
        function createSizeControlPanel() {
            // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—É—é –ø–∞–Ω–µ–ª—å –µ—Å–ª–∏ –µ—Å—Ç—å
            const oldPanel = document.getElementById('image-size-panel');
            if (oldPanel) {
                oldPanel.remove();
            }
            
            const panel = document.createElement('div');
            panel.id = 'image-size-panel';
            panel.className = 'image-size-panel';
            panel.style.display = 'none';
            
            panel.innerHTML = `
                <div class="size-panel-header">
                    <h4>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–æ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è</h4>
                    <button class="close-panel-btn">√ó</button>
                </div>
                <div class="size-panel-content">
                    <label>–†–∞–∑–º–µ—Ä: <span id="size-value">100</span>%</label>
                    <input type="range" id="size-slider" min="10" max="500" value="100" style="width: 100%; margin: 10px 0;">
                    <input type="number" id="size-input" min="10" max="500" value="100" style="width: 100%; padding: 8px; margin-bottom: 10px;">
                    <button id="apply-size-btn" class="apply-size-btn">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
                </div>
            `;
            
            document.body.appendChild(panel);
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
            const closeBtn = panel.querySelector('.close-panel-btn');
            const slider = panel.querySelector('#size-slider');
            const input = panel.querySelector('#size-input');
            const valueSpan = panel.querySelector('#size-value');
            const applyBtn = panel.querySelector('#apply-size-btn');
            
            closeBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                e.preventDefault();
                e.stopImmediatePropagation(); // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–µ –¥–∞–ª—å–Ω–µ–π—à–∏–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
                panel.style.display = 'none';
                selectedImage = null;
                return false;
            }, true); // –ò—Å–ø–æ–ª—å–∑—É–µ–º capture phase, —á—Ç–æ–±—ã —Å—Ä–∞–±–æ—Ç–∞—Ç—å —Ä–∞–Ω—å—à–µ –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞
            
            const updateValue = (value) => {
                const size = parseInt(value);
                valueSpan.textContent = size;
                slider.value = size;
                input.value = size;
            };
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∏–∑–º–µ–Ω–µ–Ω–∏–∏
            let sizeStateSaved = false;
            
            // –§—É–Ω–∫—Ü–∏—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞
            const applySize = () => {
                if (selectedImage) {
                    const size = parseInt(input.value);
                    const finalSize = size < 10 ? 10 : (size > 500 ? 500 : size);
                    
                    const sizeKey = selectedImage.dataset.sizeKey;
                    const imageWrapper = selectedImage.closest('.uploaded-image-wrapper');
                    const slideIndex = imageWrapper ? parseInt(imageWrapper.dataset.slideIndex) : null;
                    
                    if (slideIndex !== null && sizeKey) {
                        // –ù–∞—Ö–æ–¥–∏–º –≤—Å–µ —Å–ª–∞–π–¥—ã —Å —ç—Ç–∏–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º –ø–æ sizeKey (—Ä–∞–±–æ—Ç–∞–µ—Ç –¥–ª—è –≤—Å–µ—Ö —Ñ–æ—Ä–º–∞—Ç–æ–≤)
                        const allSlides = document.querySelectorAll('.slide');
                        allSlides.forEach(slide => {
                            const relatedImg = slide.querySelector(`img[data-size-key="${sizeKey}"]`);
                            if (relatedImg) {
                                // –ü—Ä–∏–º–µ–Ω—è–µ–º —Å—Ç–∏–ª–∏ —Å –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–º –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–º –¥–ª—è –≤—Å–µ—Ö —Ñ–æ—Ä–º–∞—Ç–æ–≤ (–≤–∫–ª—é—á–∞—è 9:16)
                                relatedImg.style.setProperty('max-width', finalSize + '%', 'important');
                                relatedImg.style.setProperty('max-height', 'none', 'important');
                                relatedImg.style.setProperty('width', 'auto', 'important');
                            }
                        });
                        
                        imageSizes[sizeKey] = finalSize;
                        saveToLocalStorage();
                    }
                }
            };
            
            // –ú–≥–Ω–æ–≤–µ–Ω–Ω–æ–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å–ª–∞–π–¥–µ—Ä–∞
            slider.addEventListener('input', (e) => {
                if (!sizeStateSaved) {
                    saveStateForUndo();
                    sizeStateSaved = true;
                }
                updateValue(e.target.value);
                applySize(); // –ü—Ä–∏–º–µ–Ω—è–µ–º —Å—Ä–∞–∑—É
            });
            
            // –ú–≥–Ω–æ–≤–µ–Ω–Ω–æ–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –∏–Ω–ø—É—Ç–∞
            input.addEventListener('input', (e) => {
                if (!sizeStateSaved) {
                    saveStateForUndo();
                    sizeStateSaved = true;
                }
                updateValue(e.target.value);
                applySize(); // –ü—Ä–∏–º–µ–Ω—è–µ–º —Å—Ä–∞–∑—É
            });
            
            applyBtn.addEventListener('click', () => {
                applySize();
                sizeStateSaved = false; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è
            });
            
            return panel;
        }
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–æ–º
        function showSizeControlPanel(img, slideIndex) {
            let panel = document.getElementById('image-size-panel');
            if (!panel) {
                panel = createSizeControlPanel();
            }
            
            // –ó–∞–∫—Ä—ã–≤–∞–µ–º –¥—Ä—É–≥–∏–µ –ø–∞–Ω–µ–ª–∏
            document.querySelectorAll('.text-edit-panel').forEach(p => p.style.display = 'none');
            
            selectedImage = img;
            const sizeKey = img.dataset.sizeKey;
            const currentSize = imageSizes[sizeKey] || 100;
            
            panel.querySelector('#size-slider').value = currentSize;
            panel.querySelector('#size-input').value = currentSize;
            panel.querySelector('#size-value').textContent = currentSize;
            
            // –ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä—É–µ–º –ø–∞–Ω–µ–ª—å —Å–ø—Ä–∞–≤–∞ –æ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
            const imgRect = img.getBoundingClientRect();
            const slideWrapper = img.closest('.slide-wrapper');
            
            let leftPos = imgRect.right + 20;
            let topPos = imgRect.top + window.scrollY;
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –≤—ã—Ö–æ–¥–∏—Ç –ª–∏ –ø–∞–Ω–µ–ª—å –∑–∞ –ø—Ä–∞–≤—ã–π –∫—Ä–∞–π —ç–∫—Ä–∞–Ω–∞
            if (leftPos + 300 > window.innerWidth) {
                leftPos = imgRect.left - 320; // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–ª–µ–≤–∞ –æ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –≤—ã—Ö–æ–¥–∏—Ç –ª–∏ –ø–∞–Ω–µ–ª—å –∑–∞ –Ω–∏–∂–Ω–∏–π –∫—Ä–∞–π —ç–∫—Ä–∞–Ω–∞
            if (topPos + 200 > window.innerHeight + window.scrollY) {
                topPos = window.innerHeight + window.scrollY - 220;
            }
            
            panel.style.top = topPos + 'px';
            panel.style.left = leftPos + 'px';
            panel.style.display = 'block';
            panel.style.visibility = 'visible';
            panel.style.opacity = '1';
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ø–∞–Ω–µ–ª–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –æ—Ç—Å—Ç—É–ø–∞–º–∏ –º–µ–∂–¥—É –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º–∏
        function createGapControlPanel() {
            // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—É—é –ø–∞–Ω–µ–ª—å –µ—Å–ª–∏ –µ—Å—Ç—å
            const oldPanel = document.getElementById('image-gap-panel');
            if (oldPanel) {
                oldPanel.remove();
            }
            
            const panel = document.createElement('div');
            panel.id = 'image-gap-panel';
            panel.className = 'image-size-panel';
            panel.style.display = 'none';
            
            panel.innerHTML = `
                <div class="size-panel-header">
                    <h4>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—Ç—Å—Ç—É–ø–∞–º–∏ –º–µ–∂–¥—É –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º–∏</h4>
                    <button class="close-panel-btn">√ó</button>
                </div>
                <div class="size-panel-content">
                    <label>–û—Ç—Å—Ç—É–ø: <span id="gap-value">15</span>px</label>
                    <input type="range" id="gap-slider" min="0" max="100" value="15" style="width: 100%; margin: 10px 0;">
                    <input type="number" id="gap-input" min="0" max="100" value="15" style="width: 100%; padding: 8px; margin-bottom: 10px;">
                </div>
            `;
            
            document.body.appendChild(panel);
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
            const closeBtn = panel.querySelector('.close-panel-btn');
            const slider = panel.querySelector('#gap-slider');
            const input = panel.querySelector('#gap-input');
            const valueSpan = panel.querySelector('#gap-value');
            
            const updateValue = (value) => {
                const gap = parseInt(value);
                valueSpan.textContent = gap;
                slider.value = gap;
                input.value = gap;
            };
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∏–∑–º–µ–Ω–µ–Ω–∏–∏
            let gapStateSaved = false;
            
            // –§—É–Ω–∫—Ü–∏—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –æ—Ç—Å—Ç—É–ø–∞
            const applyGap = () => {
                if (selectedImageContainer) {
                    const gap = parseInt(input.value);
                    const finalGap = gap < 0 ? 0 : (gap > 100 ? 100 : gap);
                    
                    const slideIndex = parseInt(selectedImageContainer.dataset.slideIndex);
                    const gapKey = `gap_${slideIndex}`;
                    
                    if (slideIndex !== null) {
                        // –ü—Ä–∏–º–µ–Ω—è–µ–º –æ—Ç—Å—Ç—É–ø –∫–æ –≤—Å–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞–º —Å —ç—Ç–∏–º slideIndex (–≤—Å–µ —Ñ–æ—Ä–º–∞—Ç—ã)
                        const allSlides = document.querySelectorAll('.slide');
                        allSlides.forEach(slide => {
                            const container = slide.querySelector(`.slide-image-container[data-slide-index="${slideIndex}"]`);
                            if (container) {
                                container.style.gap = finalGap + 'px';
                            }
                        });
                        
                        imageGaps[gapKey] = finalGap;
                        saveToLocalStorage();
                    }
                }
            };
            
            closeBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                e.preventDefault();
                e.stopImmediatePropagation(); // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–µ –¥–∞–ª—å–Ω–µ–π—à–∏–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
                panel.style.display = 'none';
                selectedImageContainer = null;
                return false;
            }, true); // –ò—Å–ø–æ–ª—å–∑—É–µ–º capture phase, —á—Ç–æ–±—ã —Å—Ä–∞–±–æ—Ç–∞—Ç—å —Ä–∞–Ω—å—à–µ –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞
            
            // –ú–≥–Ω–æ–≤–µ–Ω–Ω–æ–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å–ª–∞–π–¥–µ—Ä–∞
            slider.addEventListener('input', (e) => {
                if (!gapStateSaved) {
                    saveStateForUndo();
                    gapStateSaved = true;
                }
                updateValue(e.target.value);
                applyGap(); // –ü—Ä–∏–º–µ–Ω—è–µ–º —Å—Ä–∞–∑—É
            });
            
            // –ú–≥–Ω–æ–≤–µ–Ω–Ω–æ–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –∏–Ω–ø—É—Ç–∞
            input.addEventListener('input', (e) => {
                if (!gapStateSaved) {
                    saveStateForUndo();
                    gapStateSaved = true;
                }
                updateValue(e.target.value);
                applyGap(); // –ü—Ä–∏–º–µ–Ω—è–µ–º —Å—Ä–∞–∑—É
            });
            
            return panel;
        }
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –æ—Ç—Å—Ç—É–ø–∞–º–∏
        function showGapControlPanel(container, slideIndex) {
            let panel = document.getElementById('image-gap-panel');
            if (!panel) {
                panel = createGapControlPanel();
            }
            
            // –ó–∞–∫—Ä—ã–≤–∞–µ–º –¥—Ä—É–≥–∏–µ –ø–∞–Ω–µ–ª–∏
            document.querySelectorAll('.text-edit-panel').forEach(p => p.style.display = 'none');
            document.querySelectorAll('.image-size-panel').forEach(p => {
                if (p.id !== 'image-gap-panel') p.style.display = 'none';
            });
            
            selectedImageContainer = container;
            const gapKey = `gap_${slideIndex}`;
            const currentGap = imageGaps[gapKey] || 15;
            
            panel.querySelector('#gap-slider').value = currentGap;
            panel.querySelector('#gap-input').value = currentGap;
            panel.querySelector('#gap-value').textContent = currentGap;
            
            // –ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä—É–µ–º –ø–∞–Ω–µ–ª—å —Å–ø—Ä–∞–≤–∞ –æ—Ç –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
            const containerRect = container.getBoundingClientRect();
            const slideWrapper = container.closest('.slide-wrapper');
            
            panel.style.display = 'block';
            panel.style.position = 'fixed';
            panel.style.top = containerRect.top + 'px';
            panel.style.left = (containerRect.right + 20) + 'px';
            panel.style.zIndex = '100001';
            panel.style.opacity = '1';
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ø–∞–Ω–µ–ª–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
        function createContainerSettingsPanel() {
            // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—É—é –ø–∞–Ω–µ–ª—å –µ—Å–ª–∏ –µ—Å—Ç—å
            const oldPanel = document.getElementById('container-settings-panel');
            if (oldPanel) {
                oldPanel.remove();
            }
            
            const panel = document.createElement('div');
            panel.id = 'container-settings-panel';
            panel.className = 'image-size-panel';
            panel.style.display = 'none';
            
            panel.innerHTML = `
                <div class="size-panel-header">
                    <h4>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π</h4>
                    <button class="close-panel-btn">√ó</button>
                </div>
                <div class="size-panel-content">
                    <div style="margin-bottom: 15px;">
                        <label>–û—Ç—Å—Ç—É–ø—ã –º–µ–∂–¥—É –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º–∏: <span id="container-gap-value">15</span>px</label>
                        <input type="range" id="container-gap-slider" min="0" max="100" value="15" style="width: 100%; margin: 10px 0;">
                        <input type="number" id="container-gap-input" min="0" max="100" value="15" style="width: 100%; padding: 8px; margin-bottom: 10px;">
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label>–í—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ:</label>
                        <div style="display: flex; gap: 10px; margin: 10px 0;">
                            <button class="align-container-btn" data-align="flex-start" title="–ü–æ –ª–µ–≤–æ–º—É –∫—Ä–∞—é">‚¨Ö</button>
                            <button class="align-container-btn" data-align="center" title="–ü–æ —Ü–µ–Ω—Ç—Ä—É">‚¨å</button>
                            <button class="align-container-btn" data-align="flex-end" title="–ü–æ –ø—Ä–∞–≤–æ–º—É –∫—Ä–∞—é">‚û°</button>
                            <button class="align-container-btn" data-align="space-between" title="–†–∞—Å–ø—Ä–µ–¥–µ–ª–∏—Ç—å">‚¨å‚¨å</button>
                        </div>
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label>–û–∫—Ä—É–≥–ª–µ–Ω–∏–µ —É–≥–ª–æ–≤: <span id="container-radius-value">0</span>px</label>
                        <input type="range" id="container-radius-slider" min="0" max="50" value="0" style="width: 100%; margin: 10px 0;">
                        <input type="number" id="container-radius-input" min="0" max="50" value="0" style="width: 100%; padding: 8px; margin-bottom: 10px;">
                    </div>
                </div>
            `;
            
            document.body.appendChild(panel);
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
            const closeBtn = panel.querySelector('.close-panel-btn');
            const gapSlider = panel.querySelector('#container-gap-slider');
            const gapInput = panel.querySelector('#container-gap-input');
            const gapValue = panel.querySelector('#container-gap-value');
            const radiusSlider = panel.querySelector('#container-radius-slider');
            const radiusInput = panel.querySelector('#container-radius-input');
            const radiusValue = panel.querySelector('#container-radius-value');
            const alignButtons = panel.querySelectorAll('.align-container-btn');
            
            const updateGapValue = (value) => {
                const gap = parseInt(value);
                gapValue.textContent = gap;
                gapSlider.value = gap;
                gapInput.value = gap;
            };
            
            const updateRadiusValue = (value) => {
                const radius = parseInt(value);
                radiusValue.textContent = radius;
                radiusSlider.value = radius;
                radiusInput.value = radius;
            };
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∏–∑–º–µ–Ω–µ–Ω–∏–∏
            let settingsStateSaved = false;
            panel._settingsStateSaved = false;
            
            // –§—É–Ω–∫—Ü–∏—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫
            const applySettings = () => {
                if (selectedImageContainer) {
                    const slideIndex = parseInt(selectedImageContainer.dataset.slideIndex);
                    const settingsKey = `container_${slideIndex}`;
                    
                    const gap = parseInt(gapInput.value);
                    const finalGap = gap < 0 ? 0 : (gap > 100 ? 100 : gap);
                    
                    const radius = parseInt(radiusInput.value);
                    const finalRadius = radius < 0 ? 0 : (radius > 50 ? 50 : radius);
                    
                    const align = selectedImageContainer.dataset.justifyContent || 'center';
                    
                    if (slideIndex !== null) {
                        // –ü—Ä–∏–º–µ–Ω—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–æ –≤—Å–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞–º —Å —ç—Ç–∏–º slideIndex (–≤—Å–µ —Ñ–æ—Ä–º–∞—Ç—ã)
                        const allSlides = document.querySelectorAll('.slide');
                        allSlides.forEach(slide => {
                            const container = slide.querySelector(`.slide-image-container[data-slide-index="${slideIndex}"]`);
                            if (container) {
                                container.style.gap = finalGap + 'px';
                                container.style.justifyContent = align;
                                container.style.borderRadius = finalRadius + 'px';
                                
                                // –ü—Ä–∏–º–µ–Ω—è–µ–º –æ–∫—Ä—É–≥–ª–µ–Ω–∏–µ –∫ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º –≤–Ω—É—Ç—Ä–∏
                                const images = container.querySelectorAll('img');
                                images.forEach(img => {
                                    img.style.borderRadius = finalRadius + 'px';
                                });
                            }
                        });
                        
                        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
                        containerSettings[settingsKey] = {
                            gap: finalGap,
                            align: align,
                            radius: finalRadius
                        };
                        saveToLocalStorage();
                    }
                }
            };
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º applySettings –Ω–∞ –ø–∞–Ω–µ–ª–∏ –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∏–∑ –¥—Ä—É–≥–∏—Ö —Ñ—É–Ω–∫—Ü–∏–π
            panel._applySettings = applySettings;
            
            closeBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                e.preventDefault();
                e.stopImmediatePropagation();
                panel.style.display = 'none';
                selectedImageContainer = null;
                return false;
            }, true);
            
            // –ú–≥–Ω–æ–≤–µ–Ω–Ω–æ–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –æ—Ç—Å—Ç—É–ø–æ–≤
            gapSlider.addEventListener('input', (e) => {
                if (!panel._settingsStateSaved) {
                    saveStateForUndo();
                    panel._settingsStateSaved = true;
                }
                updateGapValue(e.target.value);
                applySettings();
            });
            
            gapInput.addEventListener('input', (e) => {
                if (!panel._settingsStateSaved) {
                    saveStateForUndo();
                    panel._settingsStateSaved = true;
                }
                updateGapValue(e.target.value);
                applySettings();
            });
            
            // –ú–≥–Ω–æ–≤–µ–Ω–Ω–æ–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –æ–∫—Ä—É–≥–ª–µ–Ω–∏—è
            radiusSlider.addEventListener('input', (e) => {
                if (!panel._settingsStateSaved) {
                    saveStateForUndo();
                    panel._settingsStateSaved = true;
                }
                updateRadiusValue(e.target.value);
                applySettings();
            });
            
            radiusInput.addEventListener('input', (e) => {
                if (!panel._settingsStateSaved) {
                    saveStateForUndo();
                    panel._settingsStateSaved = true;
                }
                updateRadiusValue(e.target.value);
                applySettings();
            });
            
            // –ú–≥–Ω–æ–≤–µ–Ω–Ω–æ–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏—è
            alignButtons.forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    if (!panel._settingsStateSaved) {
                        saveStateForUndo();
                        panel._settingsStateSaved = true;
                    }
                    alignButtons.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    if (selectedImageContainer) {
                        selectedImageContainer.dataset.justifyContent = btn.dataset.align;
                        applySettings();
                    }
                });
            });
            
            return panel;
        }
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–∞–Ω–µ–ª—å –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
        function showContainerSettingsPanel(container, slideIndex) {
            let panel = document.getElementById('container-settings-panel');
            const panelExisted = !!panel;
            if (!panel) {
                panel = createContainerSettingsPanel();
            }
            
            // –ó–∞–∫—Ä—ã–≤–∞–µ–º –¥—Ä—É–≥–∏–µ –ø–∞–Ω–µ–ª–∏
            document.querySelectorAll('.text-edit-panel').forEach(p => p.style.display = 'none');
            document.querySelectorAll('.image-size-panel').forEach(p => {
                if (p.id !== 'container-settings-panel') p.style.display = 'none';
            });
            
            selectedImageContainer = container;
            const settingsKey = `container_${slideIndex}`;
            const savedSettings = containerSettings[settingsKey] || {
                gap: 15,
                align: 'center',
                radius: 0
            };
            
            // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è –∏–∑ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
            const currentGap = parseInt(container.style.gap) || savedSettings.gap || 15;
            const currentAlign = container.style.justifyContent || savedSettings.align || 'center';
            const currentRadius = parseInt(container.style.borderRadius) || savedSettings.radius || 0;
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º dataset –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π —Ä–∞–±–æ—Ç—ã applySettings
            container.dataset.justifyContent = currentAlign;
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –ø–∞–Ω–µ–ª–∏
            if (panel._settingsStateSaved !== undefined) {
                panel._settingsStateSaved = false;
            }
            
            panel.querySelector('#container-gap-slider').value = currentGap;
            panel.querySelector('#container-gap-input').value = currentGap;
            panel.querySelector('#container-gap-value').textContent = currentGap;
            
            panel.querySelector('#container-radius-slider').value = currentRadius;
            panel.querySelector('#container-radius-input').value = currentRadius;
            panel.querySelector('#container-radius-value').textContent = currentRadius;
            
            // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏—è
            const alignButtons = panel.querySelectorAll('.align-container-btn');
            alignButtons.forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.align === currentAlign) {
                    btn.classList.add('active');
                }
            });
            
            // –ü–µ—Ä–µ—É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π –¥–ª—è –∫–Ω–æ–ø–æ–∫ –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏—è, –µ—Å–ª–∏ –ø–∞–Ω–µ–ª—å —É–∂–µ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–ª–∞
            // (–Ω–∞ —Å–ª—É—á–∞–π, –µ—Å–ª–∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –ø–æ—Ç–µ—Ä—è–Ω—ã –∏–ª–∏ –Ω–µ —Ä–∞–±–æ—Ç–∞—é—Ç)
            if (panelExisted && panel._applySettings) {
                alignButtons.forEach(btn => {
                    // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏, –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å
                    const newBtn = btn.cloneNode(true);
                    btn.parentNode.replaceChild(newBtn, btn);
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫
                    newBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        if (!panel._settingsStateSaved) {
                            saveStateForUndo();
                            panel._settingsStateSaved = true;
                        }
                        const allButtons = panel.querySelectorAll('.align-container-btn');
                        allButtons.forEach(b => b.classList.remove('active'));
                        newBtn.classList.add('active');
                        if (selectedImageContainer) {
                            selectedImageContainer.dataset.justifyContent = newBtn.dataset.align;
                            // –í—ã–∑—ã–≤–∞–µ–º applySettings —á–µ—Ä–µ–∑ –ø–∞–Ω–µ–ª—å
                            panel._applySettings();
                        }
                    });
                });
            }
            
            // –ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä—É–µ–º –ø–∞–Ω–µ–ª—å —Å–ø—Ä–∞–≤–∞ –æ—Ç –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
            const containerRect = container.getBoundingClientRect();
            
            panel.style.display = 'block';
            panel.style.position = 'fixed';
            panel.style.top = containerRect.top + 'px';
            panel.style.left = (containerRect.right + 20) + 'px';
            panel.style.zIndex = '100001';
            panel.style.opacity = '1';
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ø–∞–Ω–µ–ª–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ª–æ–≥–æ—Ç–∏–ø–æ–º
        function createLogoSettingsPanel() {
            // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—É—é –ø–∞–Ω–µ–ª—å –µ—Å–ª–∏ –µ—Å—Ç—å
            const oldPanel = document.getElementById('logo-settings-panel');
            if (oldPanel) {
                oldPanel.remove();
            }
            
            const panel = document.createElement('div');
            panel.id = 'logo-settings-panel';
            panel.className = 'image-size-panel';
            panel.style.display = 'none';
            
            panel.innerHTML = `
                <div class="size-panel-header">
                    <h4>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ª–æ–≥–æ—Ç–∏–ø–∞</h4>
                    <button class="close-panel-btn">√ó</button>
                </div>
                <div class="size-panel-content">
                    <div style="margin-bottom: 15px;">
                        <label>–†–∞–∑–º–µ—Ä (–≤—ã—Å–æ—Ç–∞): <span id="logo-height-value">60</span>px</label>
                        <input type="range" id="logo-height-slider" min="20" max="200" value="60" style="width: 100%; margin: 10px 0;">
                        <input type="number" id="logo-height-input" min="20" max="200" value="60" style="width: 100%; padding: 8px; margin-bottom: 10px;">
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label>–ü–æ–∑–∏—Ü–∏—è —Å–≤–µ—Ä—Ö—É: <span id="logo-top-value">40</span>px</label>
                        <input type="range" id="logo-top-slider" min="0" max="200" value="40" style="width: 100%; margin: 10px 0;">
                        <input type="number" id="logo-top-input" min="0" max="200" value="40" style="width: 100%; padding: 8px; margin-bottom: 10px;">
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label>–ü–æ–∑–∏—Ü–∏—è —Å–ª–µ–≤–∞: <span id="logo-left-value">40</span>px</label>
                        <input type="range" id="logo-left-slider" min="0" max="500" value="40" style="width: 100%; margin: 10px 0;">
                        <input type="number" id="logo-left-input" min="0" max="500" value="40" style="width: 100%; padding: 8px; margin-bottom: 10px;">
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label>–ü—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å: <span id="logo-opacity-value">100</span>%</label>
                        <input type="range" id="logo-opacity-slider" min="0" max="100" value="100" style="width: 100%; margin: 10px 0;">
                        <input type="number" id="logo-opacity-input" min="0" max="100" value="100" style="width: 100%; padding: 8px; margin-bottom: 10px;">
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label>–¢–µ–Ω—å (X Y Blur Color):</label>
                        <div style="display: flex; gap: 5px; margin: 10px 0;">
                            <input type="number" id="logo-shadow-x" placeholder="X" value="0" style="width: 25%; padding: 8px;">
                            <input type="number" id="logo-shadow-y" placeholder="Y" value="2" style="width: 25%; padding: 8px;">
                            <input type="number" id="logo-shadow-blur" placeholder="Blur" value="8" style="width: 25%; padding: 8px;">
                            <input type="color" id="logo-shadow-color" value="#000000" style="width: 25%; padding: 8px; height: 40px;">
                        </div>
                        <input type="number" id="logo-shadow-opacity" placeholder="–ü—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å —Ç–µ–Ω–∏ (0-100)" value="50" min="0" max="100" style="width: 100%; padding: 8px; margin-bottom: 10px;">
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label>–û–±–≤–æ–¥–∫–∞:</label>
                        <div style="display: flex; gap: 5px; margin: 10px 0;">
                            <input type="number" id="logo-border-width" placeholder="–¢–æ–ª—â–∏–Ω–∞" value="0" min="0" max="20" style="width: 33%; padding: 8px;">
                            <input type="color" id="logo-border-color" value="#ffffff" style="width: 33%; padding: 8px; height: 40px;">
                            <input type="number" id="logo-border-radius" placeholder="–†–∞–¥–∏—É—Å" value="0" min="0" max="50" style="width: 33%; padding: 8px;">
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(panel);
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
            const closeBtn = panel.querySelector('.close-panel-btn');
            const heightSlider = panel.querySelector('#logo-height-slider');
            const heightInput = panel.querySelector('#logo-height-input');
            const heightValue = panel.querySelector('#logo-height-value');
            const topSlider = panel.querySelector('#logo-top-slider');
            const topInput = panel.querySelector('#logo-top-input');
            const topValue = panel.querySelector('#logo-top-value');
            const leftSlider = panel.querySelector('#logo-left-slider');
            const leftInput = panel.querySelector('#logo-left-input');
            const leftValue = panel.querySelector('#logo-left-value');
            const opacitySlider = panel.querySelector('#logo-opacity-slider');
            const opacityInput = panel.querySelector('#logo-opacity-input');
            const opacityValue = panel.querySelector('#logo-opacity-value');
            const shadowX = panel.querySelector('#logo-shadow-x');
            const shadowY = panel.querySelector('#logo-shadow-y');
            const shadowBlur = panel.querySelector('#logo-shadow-blur');
            const shadowColor = panel.querySelector('#logo-shadow-color');
            const shadowOpacity = panel.querySelector('#logo-shadow-opacity');
            const borderWidth = panel.querySelector('#logo-border-width');
            const borderColor = panel.querySelector('#logo-border-color');
            const borderRadius = panel.querySelector('#logo-border-radius');
            
            let currentProjectId = null;
            let logoStateSaved = false;
            
            const updateHeightValue = (value) => {
                const height = parseInt(value);
                heightValue.textContent = height;
                heightSlider.value = height;
                heightInput.value = height;
            };
            
            const updateTopValue = (value) => {
                const top = parseInt(value);
                topValue.textContent = top;
                topSlider.value = top;
                topInput.value = top;
            };
            
            const updateLeftValue = (value) => {
                const left = parseInt(value);
                leftValue.textContent = left;
                leftSlider.value = left;
                leftInput.value = left;
            };
            
            const updateOpacityValue = (value) => {
                const opacity = parseInt(value);
                opacityValue.textContent = opacity;
                opacitySlider.value = opacity;
                opacityInput.value = opacity;
            };
            
            // –§—É–Ω–∫—Ü–∏—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫
            const applyLogoSettings = () => {
                if (!currentProjectId) return;
                
                const height = parseInt(heightInput.value) || 60;
                const top = parseInt(topInput.value) || 40;
                const left = parseInt(leftInput.value) || 40;
                const opacity = (parseInt(opacityInput.value) || 100) / 100;
                
                const shadowXVal = parseInt(shadowX.value) || 0;
                const shadowYVal = parseInt(shadowY.value) || 2;
                const shadowBlurVal = parseInt(shadowBlur.value) || 8;
                const shadowColorVal = shadowColor.value || '#000000';
                const shadowOpacityVal = (parseInt(shadowOpacity.value) || 50) / 100;
                const shadowRgb = hexToRgb(shadowColorVal);
                const shadow = `${shadowXVal}px ${shadowYVal}px ${shadowBlurVal}px rgba(${shadowRgb.r}, ${shadowRgb.g}, ${shadowRgb.b}, ${shadowOpacityVal})`;
                
                const borderWidthVal = parseInt(borderWidth.value) || 0;
                const borderColorVal = borderColor.value || '#ffffff';
                const borderRadiusVal = parseInt(borderRadius.value) || 0;
                
                // –ü—Ä–∏–º–µ–Ω—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–æ –≤—Å–µ–º –ª–æ–≥–æ—Ç–∏–ø–∞–º –ø—Ä–æ–µ–∫—Ç–∞
                const allSlides = document.querySelectorAll('.slide');
                allSlides.forEach(slide => {
                    const logoImg = slide.querySelector('.logo');
                    if (logoImg) {
                        logoImg.style.height = height + 'px';
                        logoImg.style.top = top + 'px';
                        logoImg.style.left = left + 'px';
                        logoImg.style.opacity = opacity;
                        logoImg.style.filter = `drop-shadow(${shadow})`;
                        
                        if (borderWidthVal > 0) {
                            logoImg.style.border = `${borderWidthVal}px solid ${borderColorVal}`;
                            logoImg.style.borderRadius = borderRadiusVal + 'px';
                        } else {
                            logoImg.style.border = 'none';
                            logoImg.style.borderRadius = '0px';
                        }
                    }
                });
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
                logoSettings[currentProjectId] = {
                    height: height,
                    top: top,
                    left: left,
                    opacity: opacity,
                    shadow: shadow,
                    border: borderWidthVal > 0,
                    borderWidth: borderWidthVal,
                    borderColor: borderColorVal,
                    borderRadius: borderRadiusVal
                };
                saveToLocalStorage();
            };
            
            // –§—É–Ω–∫—Ü–∏—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ HEX –≤ RGB
            const hexToRgb = (hex) => {
                const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
                return result ? {
                    r: parseInt(result[1], 16),
                    g: parseInt(result[2], 16),
                    b: parseInt(result[3], 16)
                } : { r: 0, g: 0, b: 0 };
            };
            
            closeBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                e.preventDefault();
                e.stopImmediatePropagation();
                panel.style.display = 'none';
                return false;
            }, true);
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –≤—Å–µ—Ö –ø–æ–ª–µ–π
            const addInputHandlers = (slider, input, valueSpan, updateFn) => {
                slider.addEventListener('input', (e) => {
                    if (!logoStateSaved) {
                        saveStateForUndo();
                        logoStateSaved = true;
                    }
                    updateFn(e.target.value);
                    applyLogoSettings();
                });
                
                input.addEventListener('input', (e) => {
                    if (!logoStateSaved) {
                        saveStateForUndo();
                        logoStateSaved = true;
                    }
                    updateFn(e.target.value);
                    applyLogoSettings();
                });
            };
            
            addInputHandlers(heightSlider, heightInput, heightValue, updateHeightValue);
            addInputHandlers(topSlider, topInput, topValue, updateTopValue);
            addInputHandlers(leftSlider, leftInput, leftValue, updateLeftValue);
            addInputHandlers(opacitySlider, opacityInput, opacityValue, updateOpacityValue);
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è —Ç–µ–Ω–∏ –∏ –æ–±–≤–æ–¥–∫–∏
            [shadowX, shadowY, shadowBlur, shadowColor, shadowOpacity, borderWidth, borderColor, borderRadius].forEach(input => {
                input.addEventListener('input', () => {
                    if (!logoStateSaved) {
                        saveStateForUndo();
                        logoStateSaved = true;
                    }
                    applyLogoSettings();
                });
            });
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ —Ñ—É–Ω–∫—Ü–∏—é —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –∑–Ω–∞—á–µ–Ω–∏–π
            panel._setValues = (projectId, settings) => {
                currentProjectId = projectId;
                logoStateSaved = false;
                
                if (settings) {
                    updateHeightValue(settings.height || 60);
                    updateTopValue(settings.top !== undefined ? settings.top : 40);
                    updateLeftValue(settings.left !== undefined ? settings.left : 40);
                    updateOpacityValue((settings.opacity || 1) * 100);
                    
                    // –ü–∞—Ä—Å–∏–º —Ç–µ–Ω—å
                    if (settings.shadow) {
                        const shadowMatch = settings.shadow.match(/(\d+)px\s+(\d+)px\s+(\d+)px\s+rgba\((\d+),\s*(\d+),\s*(\d+),\s*([\d.]+)\)/);
                        if (shadowMatch) {
                            shadowX.value = shadowMatch[1];
                            shadowY.value = shadowMatch[2];
                            shadowBlur.value = shadowMatch[3];
                            shadowOpacity.value = Math.round(parseFloat(shadowMatch[7]) * 100);
                            // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º RGB –≤ HEX –¥–ª—è color input
                            const r = parseInt(shadowMatch[4]).toString(16).padStart(2, '0');
                            const g = parseInt(shadowMatch[5]).toString(16).padStart(2, '0');
                            const b = parseInt(shadowMatch[6]).toString(16).padStart(2, '0');
                            shadowColor.value = `#${r}${g}${b}`;
                        }
                    }
                    
                    if (settings.border) {
                        borderWidth.value = settings.borderWidth || 0;
                        borderColor.value = settings.borderColor || '#ffffff';
                        borderRadius.value = settings.borderRadius || 0;
                    }
                }
            };
            
            return panel;
        }
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–∞–Ω–µ–ª—å –Ω–∞—Å—Ç—Ä–æ–µ–∫ –ª–æ–≥–æ—Ç–∏–ø–∞
        function showLogoSettingsPanel(projectId) {
            let panel = document.getElementById('logo-settings-panel');
            if (!panel) {
                panel = createLogoSettingsPanel();
            }
            
            // –ó–∞–∫—Ä—ã–≤–∞–µ–º –¥—Ä—É–≥–∏–µ –ø–∞–Ω–µ–ª–∏
            document.querySelectorAll('.text-edit-panel').forEach(p => p.style.display = 'none');
            document.querySelectorAll('.image-size-panel').forEach(p => {
                if (p.id !== 'logo-settings-panel') p.style.display = 'none';
            });
            
            const savedSettings = logoSettings[projectId] || {
                height: 60,
                top: 40,
                left: 40,
                opacity: 1,
                shadow: '0px 2px 8px rgba(0, 0, 0, 0.5)',
                border: false,
                borderWidth: 0,
                borderColor: '#ffffff',
                borderRadius: 0
            };
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è
            if (panel._setValues) {
                panel._setValues(projectId, savedSettings);
            }
            
            // –ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä—É–µ–º –ø–∞–Ω–µ–ª—å
            const firstLogo = document.querySelector('.logo');
            if (firstLogo) {
                const logoRect = firstLogo.getBoundingClientRect();
                panel.style.display = 'block';
                panel.style.position = 'fixed';
                panel.style.top = logoRect.bottom + 20 + 'px';
                panel.style.left = logoRect.left + 'px';
                panel.style.zIndex = '100001';
                panel.style.opacity = '1';
            } else {
                panel.style.display = 'block';
                panel.style.position = 'fixed';
                panel.style.top = '50%';
                panel.style.left = '50%';
                panel.style.transform = 'translate(-50%, -50%)';
                panel.style.zIndex = '100001';
                panel.style.opacity = '1';
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ø–∞–Ω–µ–ª–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ç–µ–∫—Å—Ç–∞
        function createTextEditPanel() {
            // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—É—é –ø–∞–Ω–µ–ª—å –µ—Å–ª–∏ –µ—Å—Ç—å
            const oldPanel = document.getElementById('text-edit-panel');
            if (oldPanel) {
                oldPanel.remove();
            }
            
            const panel = document.createElement('div');
            panel.id = 'text-edit-panel';
            panel.className = 'text-edit-panel';
            panel.style.display = 'none';
            
            panel.innerHTML = `
                <div class="text-panel-header">
                    <h4>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞</h4>
                    <button class="close-panel-btn">√ó</button>
                </div>
                <div class="text-panel-content">
                    <div class="text-edit-group">
                        <label>–®—Ä–∏—Ñ—Ç:</label>
                        <select id="text-font-family" style="width: 100%; padding: 8px; margin-bottom: 10px;">
                            <option value="'Comfortaa', cursive">Comfortaa</option>
                            <option value="Arial, sans-serif">Arial</option>
                            <option value="Georgia, serif">Georgia</option>
                            <option value="'Times New Roman', serif">Times New Roman</option>
                            <option value="'Courier New', monospace">Courier New</option>
                            <option value="Verdana, sans-serif">Verdana</option>
                            <option value="'Trebuchet MS', sans-serif">Trebuchet MS</option>
                            <option value="Impact, sans-serif">Impact</option>
                            <option value="'Comic Sans MS', cursive">Comic Sans MS</option>
                            <option value="'Roboto', sans-serif">Roboto</option>
                            <option value="'Open Sans', sans-serif">Open Sans</option>
                            <option value="'Montserrat', sans-serif">Montserrat</option>
                            <option value="'Playfair Display', serif">Playfair Display</option>
                        </select>
                    </div>
                    <div class="text-edit-group">
                        <label>–†–∞–∑–º–µ—Ä —à—Ä–∏—Ñ—Ç–∞:</label>
                        <input type="number" id="text-font-size" min="8" max="200" value="24" style="width: 100%; padding: 8px; margin-bottom: 10px;">
                    </div>
                    <div class="text-edit-group">
                        <label>–í—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ:</label>
                        <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                            <button class="align-btn" data-align="left" title="–ü–æ –ª–µ–≤–æ–º—É –∫—Ä–∞—é">‚¨Ö</button>
                            <button class="align-btn" data-align="center" title="–ü–æ —Ü–µ–Ω—Ç—Ä—É">‚¨å</button>
                            <button class="align-btn" data-align="right" title="–ü–æ –ø—Ä–∞–≤–æ–º—É –∫—Ä–∞—é">‚û°</button>
                            <button class="align-btn" data-align="justify" title="–ü–æ —à–∏—Ä–∏–Ω–µ">‚¨å‚¨å</button>
                        </div>
                    </div>
                    <div class="text-edit-group">
                        <label>–¶–≤–µ—Ç —Ç–µ–∫—Å—Ç–∞:</label>
                        <input type="color" id="text-color" value="#ffffff" style="width: 100%; padding: 8px; margin-bottom: 10px; height: 40px; border-radius: 6px; border: 1px solid rgba(255, 255, 255, 0.3);">
                    </div>
                    <div class="text-edit-group" style="margin-top: 20px; padding-top: 20px; border-top: 1px solid rgba(255, 255, 255, 0.1);">
                        <button id="delete-text-btn" class="delete-text-btn" style="width: 100%; padding: 12px; background: #ef4444; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600; transition: all 0.2s;">
                            üóëÔ∏è –£–¥–∞–ª–∏—Ç—å —Ç–µ–∫—Å—Ç–æ–≤—ã–π –±–ª–æ–∫
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(panel);
            
            // –§—É–Ω–∫—Ü–∏—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∏–ª–µ–π
            const applyStyles = () => {
                if (selectedTextElement) {
                    const fontFamily = fontSelect.value;
                    const fontSize = fontSizeInput.value + 'px';
                    const textAlign = document.querySelector('.align-btn.active')?.dataset.align || 'left';
                    const textColor = colorInput ? colorInput.value : '#ffffff'; // –í—Å–µ–≥–¥–∞ HEX —Ñ–æ—Ä–º–∞—Ç
                    
                    // –ü—Ä–∏–º–µ–Ω—è–µ–º —Å—Ç–∏–ª–∏ –∫ –≤—ã–±—Ä–∞–Ω–Ω–æ–º—É —ç–ª–µ–º–µ–Ω—Ç—É
                    selectedTextElement.style.fontFamily = fontFamily;
                    selectedTextElement.style.fontSize = fontSize;
                    selectedTextElement.style.textAlign = textAlign;
                    selectedTextElement.style.color = textColor;
                    
                    // –ü—Ä–∏–º–µ–Ω—è–µ–º –∫–æ –≤—Å–µ–º —Å–≤—è–∑–∞–Ω–Ω—ã–º —ç–ª–µ–º–µ–Ω—Ç–∞–º –≤ –¥—Ä—É–≥–∏—Ö —Ñ–æ—Ä–º–∞—Ç–∞—Ö
                    const slideWrapper = selectedTextElement.closest('.slide-wrapper');
                    const textType = selectedTextElement.dataset.textType;
                    
                    if (slideWrapper) {
                        // –ù–∞—Ö–æ–¥–∏–º –∏–Ω–¥–µ–∫—Å —Å–ª–∞–π–¥–∞ –ø–æ –ø–æ–∑–∏—Ü–∏–∏ slide-wrapper
                        const allWrappers = document.querySelectorAll('.slide-wrapper');
                        const slideIndex = Array.from(allWrappers).indexOf(slideWrapper);
                        
                        if (slideIndex >= 0) {
                            // –ù–∞—Ö–æ–¥–∏–º –≤—Å–µ —Å–ª–∞–π–¥—ã —Å —Ç–∞–∫–∏–º –∂–µ –∏–Ω–¥–µ–∫—Å–æ–º (–≤–∫–ª—é—á–∞—è –æ–±–∞ —Ñ–æ—Ä–º–∞—Ç–∞)
                            const slideWrappers = document.querySelectorAll('.slide-wrapper');
                            if (slideWrappers[slideIndex]) {
                                const allSlides = slideWrappers[slideIndex].querySelectorAll('.slide');
                                allSlides.forEach(slide => {
                                    let relatedElement = null;
                                    if (textType === 'title') {
                                        relatedElement = slide.querySelector('h1') || slide.querySelector('h2');
                                    } else if (textType === 'subtitle') {
                                        relatedElement = slide.querySelector('.subtitle');
                                    } else if (textType === 'paragraph') {
                                        relatedElement = slide.querySelector('p');
                                    }
                                    
                                    if (relatedElement) {
                                        relatedElement.style.fontFamily = fontFamily;
                                        relatedElement.style.fontSize = fontSize;
                                        relatedElement.style.textAlign = textAlign;
                                        relatedElement.style.color = textColor;
                                    }
                                });
                            }
                        }
                    }
                }
            };
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∏–∑–º–µ–Ω–µ–Ω–∏–∏ (–¥–µ–ª–∞–µ–º —ç—Ç–æ –æ–¥–∏–Ω —Ä–∞–∑)
            panel._stateSaved = false;
            const saveStateOnce = () => {
                if (!panel._stateSaved) {
                    saveStateForUndo();
                    panel._stateSaved = true;
                }
            };
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
            const closeBtn = panel.querySelector('.close-panel-btn');
            const fontSelect = panel.querySelector('#text-font-family');
            const fontSizeInput = panel.querySelector('#text-font-size');
            const alignButtons = panel.querySelectorAll('.align-btn');
            const colorInput = panel.querySelector('#text-color');
            
            closeBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                e.preventDefault();
                e.stopImmediatePropagation(); // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–µ –¥–∞–ª—å–Ω–µ–π—à–∏–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
                panel.style.display = 'none';
                selectedTextElement = null;
                return false;
            }, true); // –ò—Å–ø–æ–ª—å–∑—É–µ–º capture phase, —á—Ç–æ–±—ã —Å—Ä–∞–±–æ—Ç–∞—Ç—å —Ä–∞–Ω—å—à–µ –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞
            
            // –ú–≥–Ω–æ–≤–µ–Ω–Ω–æ–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —à—Ä–∏—Ñ—Ç–∞
            fontSelect.addEventListener('change', () => {
                saveStateOnce();
                applyStyles();
            });
            
            // –ú–≥–Ω–æ–≤–µ–Ω–Ω–æ–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ä–∞–∑–º–µ—Ä–∞
            fontSizeInput.addEventListener('input', () => {
                saveStateOnce();
                applyStyles();
            });
            
            // –ú–≥–Ω–æ–≤–µ–Ω–Ω–æ–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏—è
            alignButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    saveStateOnce();
                    alignButtons.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    applyStyles();
                });
            });
            
            // –ú–≥–Ω–æ–≤–µ–Ω–Ω–æ–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ü–≤–µ—Ç–∞
            if (colorInput) {
                colorInput.addEventListener('input', () => {
                    saveStateOnce();
                    applyStyles();
                });
                
                colorInput.addEventListener('change', () => {
                    saveStateOnce();
                    applyStyles();
                });
            }
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ —É–¥–∞–ª–µ–Ω–∏—è —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –±–ª–æ–∫–∞
            const deleteTextBtn = panel.querySelector('#delete-text-btn');
            if (deleteTextBtn) {
                deleteTextBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    e.preventDefault();
                    
                    if (!selectedTextElement) {
                        return;
                    }
                    
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è Undo
                    saveStateForUndo();
                    
                    // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—Å—Ç –¥–ª—è –ø–æ–∏—Å–∫–∞ —Å–≤—è–∑–∞–Ω–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
                    const textContent = selectedTextElement.textContent.trim();
                    const textType = selectedTextElement.dataset.textType;
                    const tagName = selectedTextElement.tagName.toLowerCase();
                    const className = selectedTextElement.className;
                    
                    // –ù–∞—Ö–æ–¥–∏–º –≤—Å–µ —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Ç–µ–∫—Å—Ç–æ–≤—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã –≤–æ –≤—Å–µ—Ö —Å–ª–∞–π–¥–∞—Ö (–≤—Å–µ —Ñ–æ—Ä–º–∞—Ç—ã)
                    const allSlides = document.querySelectorAll('.slide');
                    const elementsToRemove = [];
                    
                    allSlides.forEach(slide => {
                        // –ò—â–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã –ø–æ —Ç–∏–ø—É, —Ç–µ–≥—É –∏ —Å–æ–¥–µ—Ä–∂–∏–º–æ–º—É
                        let relatedElements = [];
                        
                        if (tagName === 'h1' || tagName === 'h2') {
                            // –ò—â–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏
                            relatedElements = Array.from(slide.querySelectorAll('h1.editable-text, h2.editable-text'));
                        } else if (className.includes('subtitle')) {
                            // –ò—â–µ–º –ø–æ–¥–∑–∞–≥–æ–ª–æ–≤–∫–∏
                            relatedElements = Array.from(slide.querySelectorAll('.subtitle.editable-text'));
                        } else if (tagName === 'p') {
                            // –ò—â–µ–º –ø–∞—Ä–∞–≥—Ä–∞—Ñ—ã
                            relatedElements = Array.from(slide.querySelectorAll('p.editable-text'));
                        }
                        
                        // –§–∏–ª—å—Ç—Ä—É–µ–º –ø–æ —Å–æ–¥–µ—Ä–∂–∏–º–æ–º—É –∏ —Ç–∏–ø—É
                        relatedElements.forEach(el => {
                            if (el.textContent.trim() === textContent || el === selectedTextElement) {
                                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–∏–ø, –µ—Å–ª–∏ –æ–Ω —É–∫–∞–∑–∞–Ω
                                if (!textType || el.dataset.textType === textType) {
                                    elementsToRemove.push(el);
                                }
                            }
                        });
                    });
                    
                    // –£–¥–∞–ª—è–µ–º –≤—Å–µ –Ω–∞–π–¥–µ–Ω–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã
                    elementsToRemove.forEach(el => {
                        if (el && el.parentElement) {
                            el.remove();
                        }
                    });
                    
                    // –ó–∞–∫—Ä—ã–≤–∞–µ–º –ø–∞–Ω–µ–ª—å —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
                    panel.style.display = 'none';
                    selectedTextElement = null;
                    
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è
                    saveToLocalStorage();
                    
                    showNotification('–¢–µ–∫—Å—Ç–æ–≤—ã–π –±–ª–æ–∫ —É–¥–∞–ª–µ–Ω', 'success');
                });
            }
            
            return panel;
        }
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–∞–Ω–µ–ª—å —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ç–µ–∫—Å—Ç–∞
        function showTextEditPanel(textElement) {
            let panel = document.getElementById('text-edit-panel');
            if (!panel) {
                panel = createTextEditPanel();
            }
            
            selectedTextElement = textElement;
            
            // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ —Ü–≤–µ—Ç–∞ –≤ HEX
            const rgbToHex = (rgb) => {
                if (!rgb || rgb === 'transparent') return '#ffffff';
                if (rgb.startsWith('#')) return rgb;
                if (rgb.startsWith('rgb')) {
                    const matches = rgb.match(/\d+/g);
                    if (matches && matches.length >= 3) {
                        return '#' + matches.map(x => {
                            const hex = parseInt(x).toString(16);
                            return hex.length === 1 ? '0' + hex : hex;
                        }).join('');
                    }
                }
                return '#ffffff';
            };
            
            // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–µ —Å—Ç–∏–ª–∏
            const computedStyle = window.getComputedStyle(textElement);
            const currentFontFamily = computedStyle.fontFamily || "'Comfortaa', cursive";
            const currentFontSize = parseInt(computedStyle.fontSize) || 24;
            const currentTextAlign = computedStyle.textAlign || 'left';
            const currentColor = rgbToHex(computedStyle.color);
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –≤ –ø–∞–Ω–µ–ª–∏
            if (panel._stateSaved) {
                panel._stateSaved = false;
            }
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –≤ –ø–∞–Ω–µ–ª–∏
            const fontSelect = panel.querySelector('#text-font-family');
            const fontSizeInput = panel.querySelector('#text-font-size');
            const alignButtons = panel.querySelectorAll('.align-btn');
            const colorInputEl = panel.querySelector('#text-color');
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ü–≤–µ—Ç –≤ –ø–∞–Ω–µ–ª–∏
            if (colorInputEl) {
                colorInputEl.value = currentColor;
            }
            
            // –ù–∞—Ö–æ–¥–∏–º –±–ª–∏–∂–∞–π—à–∏–π —à—Ä–∏—Ñ—Ç –≤ —Å–ø–∏—Å–∫–µ
            let selectedFont = "'Comfortaa', cursive";
            for (let option of fontSelect.options) {
                const optionFont = option.value.split(',')[0].replace(/'/g, '').trim();
                const currentFont = currentFontFamily.split(',')[0].replace(/'/g, '').trim();
                if (currentFontFamily.includes(optionFont) || optionFont === currentFont) {
                    selectedFont = option.value;
                    break;
                }
            }
            fontSelect.value = selectedFont;
            fontSizeInput.value = currentFontSize;
            
            // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏—è
            alignButtons.forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.align === currentTextAlign) {
                    btn.classList.add('active');
                }
            });
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ü–≤–µ—Ç (currentColor —É–∂–µ –≤ HEX —Ñ–æ—Ä–º–∞—Ç–µ –±–ª–∞–≥–æ–¥–∞—Ä—è rgbToHex)
            if (colorInputEl) {
                colorInputEl.value = currentColor;
            }
            
            // –ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä—É–µ–º –ø–∞–Ω–µ–ª—å —Å–ø—Ä–∞–≤–∞ –æ—Ç —Å–ª–∞–π–¥–∞
            const slideWrapper = textElement.closest('.slide-wrapper');
            const textRect = textElement.getBoundingClientRect();
            
            if (slideWrapper) {
                const rect = slideWrapper.getBoundingClientRect();
                let leftPos = rect.right + 20;
                let topPos = rect.top + window.scrollY;
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –≤—ã—Ö–æ–¥–∏—Ç –ª–∏ –ø–∞–Ω–µ–ª—å –∑–∞ –ø—Ä–∞–≤—ã–π –∫—Ä–∞–π —ç–∫—Ä–∞–Ω–∞
                if (leftPos + 300 > window.innerWidth) {
                    leftPos = textRect.left - 320; // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–ª–µ–≤–∞ –æ—Ç —ç–ª–µ–º–µ–Ω—Ç–∞
                }
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –≤—ã—Ö–æ–¥–∏—Ç –ª–∏ –ø–∞–Ω–µ–ª—å –∑–∞ –Ω–∏–∂–Ω–∏–π –∫—Ä–∞–π —ç–∫—Ä–∞–Ω–∞
                if (topPos + 400 > window.innerHeight + window.scrollY) {
                    topPos = window.innerHeight + window.scrollY - 420;
                }
                
                panel.style.top = topPos + 'px';
                panel.style.left = leftPos + 'px';
            } else {
                // –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ slide-wrapper, –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä—É–µ–º –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ —ç–ª–µ–º–µ–Ω—Ç–∞
                let leftPos = textRect.right + 20;
                let topPos = textRect.top + window.scrollY;
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≥—Ä–∞–Ω–∏—Ü—ã —ç–∫—Ä–∞–Ω–∞
                if (leftPos + 300 > window.innerWidth) {
                    leftPos = textRect.left - 320;
                }
                if (topPos + 400 > window.innerHeight + window.scrollY) {
                    topPos = window.innerHeight + window.scrollY - 420;
                }
                
                panel.style.top = topPos + 'px';
                panel.style.left = leftPos + 'px';
            }
            
            panel.style.display = 'block';
            panel.style.visibility = 'visible';
            panel.style.opacity = '1';
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ç–µ–∫—Å—Ç–∞
        function initTextEditing() {
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º –¥–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π –¥–ª—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
            document.addEventListener('click', (e) => {
                // –ü–ï–†–í–´–ú –î–ï–õ–û–ú –ø—Ä–æ–≤–µ—Ä—è–µ–º –∫–Ω–æ–ø–∫–∏ –∑–∞–∫—Ä—ã—Ç–∏—è - –¥–æ –≤—Å–µ—Ö –æ—Å—Ç–∞–ª—å–Ω—ã—Ö –ø—Ä–æ–≤–µ—Ä–æ–∫
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ø—Ä—è–º—É—é –ø–æ –∫–ª–∞—Å—Å—É –∏ —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–π –ø–∞–Ω–µ–ª–∏
                if (e.target.classList.contains('close-panel-btn') || e.target.closest('.close-panel-btn')) {
                    const closeBtn = e.target.classList.contains('close-panel-btn') ? e.target : e.target.closest('.close-panel-btn');
                    
                    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –∫–∞–∫–∞—è –ø–∞–Ω–µ–ª—å –∑–∞–∫—Ä—ã–≤–∞–µ—Ç—Å—è
                    const textPanel = closeBtn.closest('#text-edit-panel');
                    const sizePanel = closeBtn.closest('#image-size-panel');
                    const gapPanel = closeBtn.closest('#image-gap-panel');
                    
                    if (textPanel) {
                        textPanel.style.display = 'none';
                        selectedTextElement = null;
                        e.stopPropagation();
                        e.preventDefault();
                        e.stopImmediatePropagation();
                        return false;
                    }
                    
                    if (sizePanel) {
                        sizePanel.style.display = 'none';
                        selectedImage = null;
                        e.stopPropagation();
                        e.preventDefault();
                        e.stopImmediatePropagation();
                        return false;
                    }
                    
                    if (gapPanel) {
                        gapPanel.style.display = 'none';
                        selectedImageContainer = null;
                        e.stopPropagation();
                        e.preventDefault();
                        e.stopImmediatePropagation();
                        return false;
                    }
                    
                    const containerSettingsPanel = closeBtn.closest('#container-settings-panel');
                    if (containerSettingsPanel) {
                        containerSettingsPanel.style.display = 'none';
                        selectedImageContainer = null;
                        e.stopPropagation();
                        e.preventDefault();
                        e.stopImmediatePropagation();
                        return false;
                    }
                    
                    const logoSettingsPanel = closeBtn.closest('#logo-settings-panel');
                    if (logoSettingsPanel) {
                        logoSettingsPanel.style.display = 'none';
                        e.stopPropagation();
                        e.preventDefault();
                        e.stopImmediatePropagation();
                        return false;
                    }
                }
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∫–ª–∏–∫–Ω—É–ª–∏ –ª–∏ –Ω–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º—ã–π —Ç–µ–∫—Å—Ç–æ–≤—ã–π —ç–ª–µ–º–µ–Ω—Ç
                const textElement = e.target.closest('.editable-text');
                
                // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –∫–ª–∏–∫–∏ –≤–Ω—É—Ç—Ä–∏ –ø–∞–Ω–µ–ª–µ–π –∏ –º–µ–Ω—é (–∫—Ä–æ–º–µ –∫–Ω–æ–ø–∫–∏ –∑–∞–∫—Ä—ã—Ç–∏—è –∏ —É–¥–∞–ª–µ–Ω–∏—è, –∫–æ—Ç–æ—Ä—ã–µ –æ–±—Ä–∞–±–æ—Ç–∞–ª–∏ –≤—ã—à–µ)
                if (e.target.closest('.text-edit-panel') || 
                    e.target.closest('.image-size-panel') ||
                    e.target.closest('#image-gap-panel') ||
                    e.target.closest('#container-settings-panel') ||
                    e.target.closest('#logo-settings-panel') ||
                    e.target.closest('.image-context-menu') ||
                    e.target.closest('.uploaded-image-wrapper') ||
                    e.target.closest('.apply-text-btn') ||
                    e.target.closest('.apply-size-btn') ||
                    e.target.closest('.menu-btn') ||
                    e.target.closest('.align-container-btn') ||
                    e.target.closest('input') ||
                    e.target.closest('select') ||
                    (e.target.closest('button') && !e.target.closest('.close-panel-btn') && !e.target.closest('#delete-text-btn'))) {
                    return;
                }
                
                // –ó–∞–∫—Ä—ã–≤–∞–µ–º –ø–∞–Ω–µ–ª—å —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ—ë
                const textPanel = document.getElementById('text-edit-panel');
                if (textPanel && textPanel.style.display !== 'none' && !textPanel.contains(e.target) && !textElement) {
                    textPanel.style.display = 'none';
                    selectedTextElement = null;
                }
                
                // –ó–∞–∫—Ä—ã–≤–∞–µ–º –ø–∞–Ω–µ–ª—å —Ä–∞–∑–º–µ—Ä–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ—ë
                const sizePanel = document.getElementById('image-size-panel');
                if (sizePanel && sizePanel.style.display !== 'none' && !sizePanel.contains(e.target)) {
                    sizePanel.style.display = 'none';
                    selectedImage = null;
                }
                
                if (textElement) {
                    e.stopPropagation();
                    e.preventDefault();
                    // –ó–∞–∫—Ä—ã–≤–∞–µ–º –¥—Ä—É–≥–∏–µ –ø–∞–Ω–µ–ª–∏
                    document.querySelectorAll('.image-size-panel').forEach(p => p.style.display = 'none');
                    document.querySelectorAll('.image-context-menu').forEach(m => m.style.display = 'none');
                    showTextEditPanel(textElement);
                }
            }, true); // –ò—Å–ø–æ–ª—å–∑—É–µ–º capture phase –¥–ª—è –±–æ–ª–µ–µ —Ä–∞–Ω–Ω–µ–≥–æ –ø–µ—Ä–µ—Ö–≤–∞—Ç–∞
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã—á–∏—Å–ª–µ–Ω–∏—è –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
        function calculateOptimalImageSize(img, slideElement) {
            return new Promise((resolve) => {
                const checkSize = () => {
                    if (!slideElement) {
                        resolve(60);
                        return;
                    }
                    
                    const slideRect = slideElement.getBoundingClientRect();
                    const slideWidth = slideRect.width;
                    const slideHeight = slideRect.height;
                    
                    // –£—á–∏—Ç—ã–≤–∞–µ–º padding —Å–ª–∞–π–¥–∞ (–ø—Ä–∏–º–µ—Ä–Ω–æ 10% —Å –∫–∞–∂–¥–æ–π —Å—Ç–æ—Ä–æ–Ω—ã)
                    const padding = slideWidth * 0.2; // 20% –æ—Ç—Å—Ç—É–ø—ã
                    const availableWidth = slideWidth - padding;
                    const availableHeight = slideHeight - padding;
                    
                    if (img.naturalWidth && img.naturalHeight) {
                        const imgWidth = img.naturalWidth;
                        const imgHeight = img.naturalHeight;
                        
                        // –í—ã—á–∏—Å–ª—è–µ–º –ø—Ä–æ—Ü–µ–Ω—Ç, —á—Ç–æ–±—ã –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–æ–º–µ—Å—Ç–∏–ª–æ—Å—å
                        const widthRatio = (availableWidth / imgWidth) * 100;
                        const heightRatio = (availableHeight / imgHeight) * 100;
                        
                        // –ë–µ—Ä–µ–º –º–µ–Ω—å—à–∏–π –ø—Ä–æ—Ü–µ–Ω—Ç, —á—Ç–æ–±—ã –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç–æ—á–Ω–æ –ø–æ–º–µ—Å—Ç–∏–ª–æ—Å—å
                        const optimalSize = Math.min(widthRatio, heightRatio, 75); // –º–∞–∫—Å–∏–º—É–º 75%
                        
                        resolve(Math.max(optimalSize, 20)); // –º–∏–Ω–∏–º—É–º 20%
                    } else {
                        // –ï—Å–ª–∏ —Ä–∞–∑–º–µ—Ä—ã –µ—â–µ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã, –∏—Å–ø–æ–ª—å–∑—É–µ–º –¥–µ—Ñ–æ–ª—Ç
                        resolve(60);
                    }
                };
                
                if (img.complete && img.naturalWidth > 0) {
                    checkSize();
                } else {
                    img.onload = checkSize;
                    img.onerror = () => resolve(60);
                }
            });
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å –∫–æ–Ω—Ç—Ä–æ–ª–∞–º–∏ (–¥–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –∏–∑ JSON)
        async function addImageWithControls(container, imageSrc, alt, slideIndex, savedSize = null) {
            const imageWrapper = document.createElement('div');
            imageWrapper.className = 'uploaded-image-wrapper';
            imageWrapper.draggable = true;
            imageWrapper.dataset.slideIndex = slideIndex;
            
            const img = document.createElement('img');
            img.src = imageSrc;
            img.alt = alt;
            img.className = 'slide-image';
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä
            const sizeKey = `${slideIndex}_${imageSrc.substring(0, 50)}`;
            let finalSize = savedSize;
            
            // –ï—Å–ª–∏ —Ä–∞–∑–º–µ—Ä –Ω–µ –∑–∞–¥–∞–Ω, –≤—ã—á–∏—Å–ª—è–µ–º –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–π
            if (!finalSize) {
                const slideElement = container.closest('.slide') || document.querySelector(`.slide-wrapper:nth-child(${slideIndex + 1}) .slide`);
                if (slideElement) {
                    finalSize = await calculateOptimalImageSize(img, slideElement);
                } else {
                    finalSize = 60;
                }
            }
            
            imageSizes[sizeKey] = finalSize;
            img.style.setProperty('max-width', finalSize + '%', 'important');
            img.style.setProperty('max-height', 'none', 'important');
            img.style.setProperty('width', 'auto', 'important');
            img.dataset.sizeKey = sizeKey;
            img.dataset.originalSrc = imageSrc;
            
            // –ö–Ω–æ–ø–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è (—Å–∫—Ä—ã—Ç–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'delete-image-btn';
            deleteBtn.textContent = '√ó';
            deleteBtn.title = '–£–¥–∞–ª–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ';
            deleteBtn.style.display = 'none';
            deleteBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                saveStateForUndo();
                imageWrapper.remove();
                // –£–¥–∞–ª—è–µ–º –∏–∑ –≤—Å–µ—Ö —Å–≤—è–∑–∞–Ω–Ω—ã—Ö —Å–ª–∞–π–¥–æ–≤ (–≤—Å–µ —Ñ–æ—Ä–º–∞—Ç—ã)
                const allSlides = document.querySelectorAll('.slide');
                allSlides.forEach(slide => {
                    const wrapper = slide.querySelector(`.uploaded-image-wrapper img[data-size-key="${sizeKey}"]`);
                    if (wrapper) {
                        wrapper.closest('.uploaded-image-wrapper').remove();
                    }
                });
                // –£–¥–∞–ª—è–µ–º —Ä–∞–∑–º–µ—Ä –∏–∑ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞
                delete imageSizes[sizeKey];
            });
            
            // –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é –ø—Ä–∏ –∫–ª–∏–∫–µ
            const contextMenu = document.createElement('div');
            contextMenu.className = 'image-context-menu';
            contextMenu.innerHTML = `
                <button class="menu-btn delete-btn">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
                <button class="menu-btn size-btn">üìè –ò–∑–º–µ–Ω–∏—Ç—å —Ä–∞–∑–º–µ—Ä</button>
                <button class="menu-btn gap-btn">üìê –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—Ç—Å—Ç—É–ø–∞–º–∏</button>
            `;
            contextMenu.style.display = 'none';
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–µ–Ω—é –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
            img.addEventListener('click', (e) => {
                e.stopPropagation();
                e.preventDefault();
                // –ó–∞–∫—Ä—ã–≤–∞–µ–º –¥—Ä—É–≥–∏–µ –º–µ–Ω—é –∏ –ø–∞–Ω–µ–ª–∏
                document.querySelectorAll('.image-context-menu').forEach(menu => {
                    if (menu !== contextMenu) menu.style.display = 'none';
                });
                document.querySelectorAll('.text-edit-panel').forEach(panel => {
                    panel.style.display = 'none';
                });
                
                // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º –≤–∏–¥–∏–º–æ—Å—Ç—å –º–µ–Ω—é
                if (contextMenu.style.display === 'none') {
                    contextMenu.style.display = 'block';
                    const rect = img.getBoundingClientRect();
                    contextMenu.style.top = (rect.bottom + 5) + 'px';
                    contextMenu.style.left = rect.left + 'px';
                } else {
                    contextMenu.style.display = 'none';
                }
            });
            
            // –ö–Ω–æ–ø–∫–∏ –º–µ–Ω—é
            contextMenu.querySelector('.delete-btn').addEventListener('click', (e) => {
                e.stopPropagation();
                contextMenu.style.display = 'none';
                deleteBtn.click();
                // –ù–µ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
            });
            
            contextMenu.querySelector('.size-btn').addEventListener('click', (e) => {
                e.stopPropagation();
                contextMenu.style.display = 'none';
                showSizeControlPanel(img, slideIndex);
            });
            
            contextMenu.querySelector('.gap-btn').addEventListener('click', (e) => {
                e.stopPropagation();
                contextMenu.style.display = 'none';
                const container = img.closest('.slide-image-container');
                if (container) {
                    showGapControlPanel(container, slideIndex);
                }
            });
            
            // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–µ–Ω—é –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
            const closeMenuHandler = (e) => {
                if (!imageWrapper.contains(e.target) && !e.target.closest('.image-context-menu')) {
                    contextMenu.style.display = 'none';
                    document.removeEventListener('click', closeMenuHandler);
                }
            };
            setTimeout(() => {
                document.addEventListener('click', closeMenuHandler);
            }, 100);
            
            imageWrapper.appendChild(img);
            imageWrapper.appendChild(deleteBtn);
            imageWrapper.appendChild(contextMenu);
            
            // Drag and Drop
            imageWrapper.draggable = true;
            imageWrapper.dataset.slideIndex = slideIndex;
            setupImageDragDrop(imageWrapper, slideIndex);
            
            container.appendChild(imageWrapper);
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è drag and drop –¥–ª—è –≤—Å–µ—Ö —Å–ª–∞–π–¥–æ–≤ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
        function initDragDropForSlides(slideIndex) {
            const allSlides = document.querySelectorAll(`.slide-wrapper:nth-child(${slideIndex + 1}) .slide`);
            allSlides.forEach((slide) => {
                if (slide) {
                    makeDropZone(slide, slideIndex);
                }
            });
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ drag and drop –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
        function setupImageDragDrop(imageWrapper, slideIndex) {
            imageWrapper.addEventListener('dragstart', (e) => {
                e.stopPropagation();
                e.dataTransfer.effectAllowed = 'move';
                e.dataTransfer.setData('text/html', imageWrapper.outerHTML);
                e.dataTransfer.setData('text/plain', imageWrapper.querySelector('img').dataset.sizeKey);
                imageWrapper.style.opacity = '0.5';
                imageWrapper.classList.add('dragging');
                draggedElement = imageWrapper;
            });
            
            imageWrapper.addEventListener('dragend', (e) => {
                imageWrapper.style.opacity = '1';
                imageWrapper.classList.remove('dragging');
                document.querySelectorAll('.drop-zone-active').forEach(zone => {
                    zone.classList.remove('drop-zone-active');
                });
            });
        }
        
        let draggedElement = null;
        
        const dropZoneHandlers = new WeakMap();
        
        function makeDropZone(element, slideIndex) {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã –ª–∏ —É–∂–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
            if (dropZoneHandlers.has(element)) {
                return;
            }
            
            const dragoverHandler = (e) => {
                e.preventDefault();
                e.stopPropagation();
                if (e.dataTransfer) {
                    e.dataTransfer.dropEffect = 'move';
                }
                element.classList.add('drop-zone-active');
            };
            
            const dragleaveHandler = (e) => {
                if (!element.contains(e.relatedTarget)) {
                    element.classList.remove('drop-zone-active');
                }
            };
            
            const dropHandler = (e) => {
                e.preventDefault();
                e.stopPropagation();
                element.classList.remove('drop-zone-active');
                
                if (draggedElement && draggedElement.parentNode) {
                    const afterElement = getDragAfterElement(element, e.clientY);
                    
                    if (afterElement == null) {
                        element.appendChild(draggedElement);
                    } else {
                        element.insertBefore(draggedElement, afterElement);
                    }
                    
                    // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º —Å –¥—Ä—É–≥–∏–º–∏ —Å–ª–∞–π–¥–∞–º–∏ (–≤—Å–µ —Ñ–æ—Ä–º–∞—Ç—ã)
                    const slideWrapper = element.closest('.slide-wrapper');
                    if (slideWrapper) {
                        const allSlides = slideWrapper.querySelectorAll('.slide');
                        allSlides.forEach(slide => {
                            if (slide !== element && draggedElement) {
                                const sizeKey = draggedElement.querySelector('img')?.dataset.sizeKey;
                                if (sizeKey) {
                                    const relatedWrapper = slide.querySelector(`.uploaded-image-wrapper img[data-size-key="${sizeKey}"]`);
                                    if (relatedWrapper) {
                                        const relatedWrapperParent = relatedWrapper.closest('.uploaded-image-wrapper');
                                        const afterElementRelated = getDragAfterElement(slide, e.clientY);
                                        if (afterElementRelated == null) {
                                            slide.appendChild(relatedWrapperParent);
                                        } else {
                                            slide.insertBefore(relatedWrapperParent, afterElementRelated);
                                        }
                                    }
                                }
                            }
                        });
                    }
                }
            };
            
            element.addEventListener('dragover', dragoverHandler);
            element.addEventListener('dragleave', dragleaveHandler);
            element.addEventListener('drop', dropHandler);
            
            dropZoneHandlers.set(element, { dragoverHandler, dragleaveHandler, dropHandler });
        }
        
        function getDragAfterElement(container, y) {
            // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ —ç–ª–µ–º–µ–Ω—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥—É—Ç –±—ã—Ç—å —Ç–æ—á–∫–∞–º–∏ –≤—Å—Ç–∞–≤–∫–∏
            const children = [...container.children].filter(child => {
                // –ò—Å–∫–ª—é—á–∞–µ–º –∞–±—Å–æ–ª—é—Ç–Ω–æ –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã (–ª–æ–≥–æ—Ç–∏–ø, –Ω–æ–º–µ—Ä —Å–ª–∞–π–¥–∞, –≤–æ–¥—è–Ω–æ–π –∑–Ω–∞–∫)
                return !child.classList.contains('logo') && 
                       !child.classList.contains('slide-number') &&
                       !child.classList.contains('emoji') &&
                       child.tagName !== 'STYLE';
            });
            
            return children.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;
                
                if (offset < 0 && offset > closest.offset) {
                    return { offset: offset, element: child };
                } else {
                    return closest;
                }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }
        
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ —Å–ª–∞–π–¥
        function addImageToSlide(slideElement, imageSrc, slideIndex, replaceExisting = false, initialSize = null) {
            // –ï—Å–ª–∏ –Ω—É–∂–Ω–æ –∑–∞–º–µ–Ω–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–µ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
            if (replaceExisting) {
                const existingUploadedImg = slideElement.querySelector('.uploaded-image');
                if (existingUploadedImg) {
                    existingUploadedImg.src = imageSrc;
                    return existingUploadedImg;
                }
            }
            
            // –ò—â–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –∏–ª–∏ —Å–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π
            let imageContainer = slideElement.querySelector('.slide-image-container');
            const allImages = slideElement.querySelectorAll('.slide-image');
            
            // –°–æ–∑–¥–∞–µ–º –æ–±–µ—Ä—Ç–∫—É –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å –∫–æ–Ω—Ç—Ä–æ–ª–∞–º–∏
            const imageWrapper = document.createElement('div');
            imageWrapper.className = 'uploaded-image-wrapper';
            
            const img = document.createElement('img');
            img.src = imageSrc;
            img.alt = '–ó–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ';
            img.className = 'slide-image uploaded-image';
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä
            const sizeKey = `${slideIndex}_${imageSrc.substring(0, 50)}`;
            let savedSize = initialSize || imageSizes[sizeKey];
            
            // –ï—Å–ª–∏ —Ä–∞–∑–º–µ—Ä –Ω–µ –∑–∞–¥–∞–Ω, –≤—ã—á–∏—Å–ª—è–µ–º –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–π
            if (!savedSize) {
                calculateOptimalImageSize(img, slideElement).then(size => {
                    savedSize = size;
                    imageSizes[sizeKey] = size;
                    img.style.setProperty('max-width', size + '%', 'important');
                    img.style.setProperty('max-height', 'none', 'important');
                    img.style.setProperty('width', 'auto', 'important');
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –≤–æ –≤—Å–µ—Ö —Å–≤—è–∑–∞–Ω–Ω—ã—Ö —Å–ª–∞–π–¥–∞—Ö (–≤—Å–µ —Ñ–æ—Ä–º–∞—Ç—ã)
                    const allSlides = document.querySelectorAll('.slide');
                    allSlides.forEach(slide => {
                        const relatedImg = slide.querySelector(`img[data-size-key="${sizeKey}"]`);
                        if (relatedImg) {
                            relatedImg.style.setProperty('max-width', size + '%', 'important');
                            relatedImg.style.setProperty('max-height', 'none', 'important');
                            relatedImg.style.setProperty('width', 'auto', 'important');
                        }
                    });
                });
                savedSize = 60; // –í—Ä–µ–º–µ–Ω–Ω—ã–π —Ä–∞–∑–º–µ—Ä
            }
            
            imageSizes[sizeKey] = savedSize;
            img.style.setProperty('max-width', savedSize + '%', 'important');
            img.style.setProperty('max-height', 'none', 'important');
            img.style.setProperty('width', 'auto', 'important');
            img.dataset.sizeKey = sizeKey;
            img.dataset.originalSrc = imageSrc;
            
            // –ö–Ω–æ–ø–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è (—Å–∫—Ä—ã—Ç–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'delete-image-btn';
            deleteBtn.textContent = '√ó';
            deleteBtn.title = '–£–¥–∞–ª–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ';
            deleteBtn.style.display = 'none';
            deleteBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                saveStateForUndo();
                imageWrapper.remove();
                // –£–¥–∞–ª—è–µ–º –∏–∑ –≤—Å–µ—Ö —Å–≤—è–∑–∞–Ω–Ω—ã—Ö —Å–ª–∞–π–¥–æ–≤ (–≤—Å–µ —Ñ–æ—Ä–º–∞—Ç—ã)
                const allSlides = document.querySelectorAll('.slide');
                allSlides.forEach(slide => {
                    const wrapper = slide.querySelector(`.uploaded-image-wrapper img[data-size-key="${sizeKey}"]`);
                    if (wrapper) {
                        wrapper.closest('.uploaded-image-wrapper').remove();
                    }
                });
                // –£–¥–∞–ª—è–µ–º —Ä–∞–∑–º–µ—Ä –∏–∑ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞
                delete imageSizes[sizeKey];
            });
            
            // –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é –ø—Ä–∏ –∫–ª–∏–∫–µ
            const contextMenu = document.createElement('div');
            contextMenu.className = 'image-context-menu';
            contextMenu.innerHTML = `
                <button class="menu-btn delete-btn">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
                <button class="menu-btn size-btn">üìè –ò–∑–º–µ–Ω–∏—Ç—å —Ä–∞–∑–º–µ—Ä</button>
                <button class="menu-btn gap-btn">üìê –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—Ç—Å—Ç—É–ø–∞–º–∏</button>
            `;
            contextMenu.style.display = 'none';
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–µ–Ω—é –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
            img.addEventListener('click', (e) => {
                e.stopPropagation();
                e.preventDefault();
                // –ó–∞–∫—Ä—ã–≤–∞–µ–º –¥—Ä—É–≥–∏–µ –º–µ–Ω—é –∏ –ø–∞–Ω–µ–ª–∏
                document.querySelectorAll('.image-context-menu').forEach(menu => {
                    if (menu !== contextMenu) menu.style.display = 'none';
                });
                document.querySelectorAll('.text-edit-panel').forEach(panel => {
                    panel.style.display = 'none';
                });
                
                // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º –≤–∏–¥–∏–º–æ—Å—Ç—å –º–µ–Ω—é
                if (contextMenu.style.display === 'none') {
                    contextMenu.style.display = 'block';
                    const rect = img.getBoundingClientRect();
                    contextMenu.style.top = (rect.bottom + 5) + 'px';
                    contextMenu.style.left = rect.left + 'px';
                } else {
                    contextMenu.style.display = 'none';
                }
            });
            
            // –ö–Ω–æ–ø–∫–∏ –º–µ–Ω—é
            contextMenu.querySelector('.delete-btn').addEventListener('click', (e) => {
                e.stopPropagation();
                contextMenu.style.display = 'none';
                deleteBtn.click();
                // –ù–µ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
            });
            
            contextMenu.querySelector('.size-btn').addEventListener('click', (e) => {
                e.stopPropagation();
                contextMenu.style.display = 'none';
                showSizeControlPanel(img, slideIndex);
            });
            
            contextMenu.querySelector('.gap-btn').addEventListener('click', (e) => {
                e.stopPropagation();
                contextMenu.style.display = 'none';
                const container = img.closest('.slide-image-container');
                if (container) {
                    showGapControlPanel(container, slideIndex);
                }
            });
            
            // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–µ–Ω—é –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
            const closeMenuHandler = (e) => {
                if (!imageWrapper.contains(e.target) && !e.target.closest('.image-context-menu')) {
                    contextMenu.style.display = 'none';
                    document.removeEventListener('click', closeMenuHandler);
                }
            };
            setTimeout(() => {
                document.addEventListener('click', closeMenuHandler);
            }, 100);
            
            imageWrapper.appendChild(img);
            imageWrapper.appendChild(deleteBtn);
            imageWrapper.appendChild(contextMenu);
            
            // Drag and Drop
            imageWrapper.draggable = true;
            imageWrapper.dataset.slideIndex = slideIndex;
            setupImageDragDrop(imageWrapper, slideIndex);
            
            // –í—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π (–¥–ª—è —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏—è –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –æ—Ç—Å—Ç—É–ø–∞–º–∏)
            if (!imageContainer) {
                // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
                imageContainer = document.createElement('div');
                imageContainer.className = 'slide-image-container';
                imageContainer.dataset.slideIndex = slideIndex;
                
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º gap –∏–∑ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –∏–ª–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
                const containerGapKey = `gap_${slideIndex}`;
                const savedGap = imageGaps[containerGapKey] || 15;
                imageContainer.style.gap = savedGap + 'px';
                
                // –ü—Ä–∏–º–µ–Ω—è–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
                const settingsKey = `container_${slideIndex}`;
                const savedSettings = containerSettings[settingsKey];
                if (savedSettings) {
                    imageContainer.style.justifyContent = savedSettings.align || 'center';
                    imageContainer.style.borderRadius = (savedSettings.radius || 0) + 'px';
                    // –ü—Ä–∏–º–µ–Ω—è–µ–º –æ–∫—Ä—É–≥–ª–µ–Ω–∏–µ –∫ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º
                    const images = imageContainer.querySelectorAll('img');
                    images.forEach(img => {
                        img.style.borderRadius = (savedSettings.radius || 0) + 'px';
                    });
                }
                
                // –ü–µ—Ä–µ–º–µ—â–∞–µ–º –≤—Å–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
                allImages.forEach(existingImg => {
                    const existingWrapper = existingImg.closest('.uploaded-image-wrapper');
                    if (existingWrapper && existingWrapper.parentElement !== imageContainer) {
                        // –ù–∞—Ö–æ–¥–∏–º –º–µ—Å—Ç–æ –¥–ª—è –≤—Å—Ç–∞–≤–∫–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
                        const insertBefore = existingWrapper;
                        existingWrapper.parentNode.insertBefore(imageContainer, insertBefore);
                        imageContainer.appendChild(existingWrapper);
                    }
                });
                
                // –ï—Å–ª–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –µ—â–µ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω –≤ —Å–ª–∞–π–¥, –¥–æ–±–∞–≤–ª—è–µ–º –µ–≥–æ
                if (!imageContainer.parentElement) {
                    // –í—Å—Ç–∞–≤–ª—è–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –≤ –ø–æ–¥—Ö–æ–¥—è—â–µ–µ –º–µ—Å—Ç–æ
                    const title = slideElement.querySelector('h1') || slideElement.querySelector('h2');
                    const subtitle = slideElement.querySelector('.subtitle');
                    const paragraph = slideElement.querySelector('p');
                    const cta = slideElement.querySelector('.cta');
                    
                    if (slideElement.classList.contains('slide-1')) {
                        const titleH1 = slideElement.querySelector('h1');
                        if (titleH1) {
                            const subtitle = slideElement.querySelector('.subtitle');
                            if (subtitle) {
                                slideElement.insertBefore(imageContainer, subtitle);
                            } else {
                                if (titleH1.nextSibling) {
                                    slideElement.insertBefore(imageContainer, titleH1.nextSibling);
                                } else {
                                    slideElement.appendChild(imageContainer);
                                }
                            }
                        } else {
                            slideElement.appendChild(imageContainer);
                        }
                    } else if (title && subtitle) {
                        slideElement.insertBefore(imageContainer, subtitle);
                    } else if (title && paragraph) {
                        slideElement.insertBefore(imageContainer, paragraph);
                    } else if (title) {
                        slideElement.insertBefore(imageContainer, title.nextSibling);
                    } else if (subtitle) {
                        slideElement.insertBefore(imageContainer, subtitle);
                    } else if (paragraph) {
                        slideElement.insertBefore(imageContainer, paragraph);
                    } else if (cta) {
                        slideElement.insertBefore(imageContainer, cta);
                    } else {
                        slideElement.appendChild(imageContainer);
                    }
                }
            }
            
            // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
            imageContainer.appendChild(imageWrapper);
            
            return img;
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å–ª–∞–π–¥–æ–≤ –∏–∑ –ø—Ä–æ–µ–∫—Ç–∞
        function generateSlides(project) {
            const container = document.getElementById('slides-container');
            container.innerHTML = '';
            // –ù–µ —Å–±—Ä–∞—Å—ã–≤–∞–µ–º slideImages, —á—Ç–æ–±—ã —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
            // slideImages = {}; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
            
            project.slides.forEach((slideData, index) => {
                const slideWrapper = document.createElement('div');
                slideWrapper.className = 'slide-wrapper';
                
                // –°–æ–∑–¥–∞–µ–º —Å–ª–∞–π–¥ –≤ —Ñ–æ—Ä–º–∞—Ç–µ 1:1
                const slide11 = createSlideFromJSON(
                    slideData,
                    index,
                    project.slides.length,
                    project.logo,
                    project.watermark
                );
                slide11.classList.add('slide-format-1-1');
                
                // –°–æ–∑–¥–∞–µ–º —Å–ª–∞–π–¥ –≤ —Ñ–æ—Ä–º–∞—Ç–µ 9:16
                const slide916 = createSlideFromJSON(
                    slideData,
                    index,
                    project.slides.length,
                    project.logo,
                    project.watermark
                );
                slide916.classList.add('slide-format-9-16', 'format-9-16');
                
                // –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (–ø—Ä–∏–≤—è–∑—ã–≤–∞–µ–º –∫ –æ–±–æ–∏–º —Å–ª–∞–π–¥–∞–º)
                const uploadButton = createImageUploadButton(index, slide11, [slide916]);
                
                // –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Å–ª–∞–π–¥–æ–≤
                const slidesContainer = document.createElement('div');
                slidesContainer.className = 'slides-preview-container';
                slidesContainer.appendChild(slide11);
                slidesContainer.appendChild(slide916);
                
                slideWrapper.appendChild(slidesContainer);
                slideWrapper.appendChild(uploadButton);
                container.appendChild(slideWrapper);
            });
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º drag and drop –¥–ª—è –≤—Å–µ—Ö —Å–ª–∞–π–¥–æ–≤ –ø–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤ DOM
            setTimeout(() => {
                project.slides.forEach((slideData, index) => {
                    initDragDropForSlides(index);
                });
                
                // –ü—Ä–∏–º–µ–Ω—è–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ gap –∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
                Object.keys(imageGaps).forEach(gapKey => {
                    const slideIndex = parseInt(gapKey.replace('gap_', ''));
                    const gap = imageGaps[gapKey];
                    const allSlides = document.querySelectorAll('.slide');
                    allSlides.forEach(slide => {
                        const container = slide.querySelector(`.slide-image-container[data-slide-index="${slideIndex}"]`);
                        if (container) {
                            container.style.gap = gap + 'px';
                        }
                    });
                });
                
                // –ü—Ä–∏–º–µ–Ω—è–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
                Object.keys(containerSettings).forEach(settingsKey => {
                    const slideIndex = parseInt(settingsKey.replace('container_', ''));
                    const settings = containerSettings[settingsKey];
                    const allSlides = document.querySelectorAll('.slide');
                    allSlides.forEach(slide => {
                        const container = slide.querySelector(`.slide-image-container[data-slide-index="${slideIndex}"]`);
                        if (container && settings) {
                            container.style.justifyContent = settings.align || 'center';
                            container.style.borderRadius = (settings.radius || 0) + 'px';
                            // –ü—Ä–∏–º–µ–Ω—è–µ–º –æ–∫—Ä—É–≥–ª–µ–Ω–∏–µ –∫ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º
                            const images = container.querySelectorAll('img');
                            images.forEach(img => {
                                img.style.borderRadius = (settings.radius || 0) + 'px';
                            });
                        }
                    });
                });
                
                // –ü—Ä–∏–º–µ–Ω—è–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ª–æ–≥–æ—Ç–∏–ø–æ–≤
                Object.keys(logoSettings).forEach(projectId => {
                    const settings = logoSettings[projectId];
                    const allSlides = document.querySelectorAll('.slide');
                    allSlides.forEach(slide => {
                        const logoImg = slide.querySelector('.logo');
                        if (logoImg && settings) {
                            if (settings.height) logoImg.style.height = settings.height + 'px';
                            if (settings.top !== undefined) logoImg.style.top = settings.top + 'px';
                            if (settings.left !== undefined) logoImg.style.left = settings.left + 'px';
                            if (settings.opacity !== undefined) logoImg.style.opacity = settings.opacity;
                            if (settings.shadow) logoImg.style.filter = `drop-shadow(${settings.shadow})`;
                            if (settings.border && settings.borderWidth > 0) {
                                logoImg.style.border = `${settings.borderWidth}px solid ${settings.borderColor || '#ffffff'}`;
                                logoImg.style.borderRadius = (settings.borderRadius || 0) + 'px';
                            }
                        }
                    });
                });
            }, 500);
            
            currentProjectId = project.id;
            updateFormatButtons();
            updatePreviewMode();
            saveToLocalStorage(); // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ –ø—Ä–æ–µ–∫—Ç–∞
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ä–µ–∂–∏–º–∞ –ø—Ä–µ–≤—å—é
        function updatePreviewMode() {
            const previewBoth = document.getElementById('preview-both');
            const slides11 = document.querySelectorAll('.slide-format-1-1');
            const slides916 = document.querySelectorAll('.slide-format-9-16');
            
            if (previewBoth && previewBoth.checked) {
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–±–∞ —Ñ–æ—Ä–º–∞—Ç–∞ —Ä—è–¥–æ–º –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ
                slides11.forEach(slide => {
                    slide.style.display = 'flex';
                    slide.classList.remove('format-9-16');
                });
                slides916.forEach(slide => {
                    slide.style.display = 'flex';
                    slide.classList.add('format-9-16');
                });
                // –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –≤ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–º —Ä–µ–∂–∏–º–µ
                document.querySelectorAll('.slides-preview-container').forEach(container => {
                    container.style.flexDirection = 'row';
                });
            } else {
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –∞–∫—Ç–∏–≤–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç
                const activeFormat = document.querySelector('.format-btn.active[data-format]');
                const format = activeFormat ? activeFormat.dataset.format : '1-1';
                
                slides11.forEach(slide => {
                    if (format === '1-1') {
                        slide.style.display = 'flex';
                        slide.classList.remove('format-9-16');
                    } else {
                        slide.style.display = 'none';
                    }
                });
                
                slides916.forEach(slide => {
                    if (format === '9-16') {
                        slide.style.display = 'flex';
                        slide.classList.add('format-9-16');
                    } else {
                        slide.style.display = 'none';
                    }
                });
            }
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–Ω–æ–ø–æ–∫ —Ñ–æ—Ä–º–∞—Ç–∞
        function initFormatButtons() {
            const formatButtons = document.querySelectorAll('.format-btn[data-format]');
            const previewBoth = document.getElementById('preview-both');
            
            formatButtons.forEach(btn => {
                btn.addEventListener('click', function() {
                    formatButtons.forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    updatePreviewMode();
                });
            });
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —á–µ–∫–±–æ–∫—Å–∞ –ø—Ä–µ–≤—å—é
            if (previewBoth) {
                previewBoth.addEventListener('change', () => {
                    updatePreviewMode();
                });
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–Ω–æ–ø–æ–∫ —Ñ–æ—Ä–º–∞—Ç–∞
        function updateFormatButtons() {
            // –ö–Ω–æ–ø–∫–∏ —É–∂–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã, –ø—Ä–æ—Å—Ç–æ –æ–±–Ω–æ–≤–ª—è–µ–º —Ñ–æ—Ä–º–∞—Ç —Å–ª–∞–π–¥–æ–≤
            updatePreviewMode();
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        document.addEventListener('DOMContentLoaded', () => {
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ localStorage
            loadFromLocalStorage();
            
            // –ï—Å–ª–∏ –µ—Å—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –ø—Ä–æ–µ–∫—Ç—ã, –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏—Ö
            if (projectsData.length > 0) {
                if (currentProjectId) {
                    const project = projectsData.find(p => p.id === currentProjectId);
                    if (project) {
                        generateSlides(project);
                    } else if (projectsData.length > 0) {
                        // –ï—Å–ª–∏ —Ç–µ–∫—É—â–∏–π –ø—Ä–æ–µ–∫—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω, –∑–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–≤—ã–π
                        generateSlides(projectsData[0]);
                        currentProjectId = projectsData[0].id;
                    }
                } else if (projectsData.length > 0) {
                    generateSlides(projectsData[0]);
                    currentProjectId = projectsData[0].id;
                }
                renderProjectsList();
                showNotification('–î–∞–Ω–Ω—ã–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –∏–∑ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è', 'success');
            }
            
            initFormatButtons();
            initImportJSON();
            initSaveJSON();
            initExport();
            initTextEditing();
        });
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ –ø—Ä–æ–µ–∫—Ç–æ–≤
        function renderProjectsList() {
            const list = document.getElementById('projects-list');
            list.innerHTML = '';
            
            projectsData.forEach(project => {
                const item = document.createElement('div');
                item.className = `project-item ${currentProjectId === project.id ? 'active' : ''}`;
                item.textContent = project.name;
                item.addEventListener('click', () => {
                    currentProjectId = project.id;
                    generateSlides(project);
                    renderProjectsList();
                    saveToLocalStorage(); // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ –ø—Ä–æ–µ–∫—Ç–∞
                });
                list.appendChild(item);
            });
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ JSON —Ñ–∞–π–ª–∞
        function processJSONFile(file) {
            if (!file) return;
            
            if (!file.name.endsWith('.json')) {
                showNotification('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ JSON —Ñ–∞–π–ª', 'warning');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    const data = JSON.parse(event.target.result);
                    if (data.projects && Array.isArray(data.projects)) {
                        projectsData = data.projects;
                        if (projectsData.length > 0) {
                            currentProjectId = projectsData[0].id;
                            generateSlides(projectsData[0]);
                            renderProjectsList();
                            saveToLocalStorage(); // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–∏ –∏–º–ø–æ—Ä—Ç–µ
                            showNotification(`–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ –ø—Ä–æ–µ–∫—Ç–æ–≤: ${projectsData.length}`, 'success');
                        }
                    } else {
                        showNotification('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç JSON. –û–∂–∏–¥–∞–µ—Ç—Å—è –æ–±—ä–µ–∫—Ç —Å –ø–æ–ª–µ–º "projects"', 'error');
                    }
                } catch (error) {
                    showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–∞—Ä—Å–∏–Ω–≥–µ JSON: ' + error.message, 'error');
                    console.error(error);
                }
            };
            reader.readAsText(file);
        }
        
        // –ò–º–ø–æ—Ä—Ç JSON
        function initImportJSON() {
            const importBtn = document.getElementById('import-json-btn');
            const importInput = document.getElementById('import-json-input');
            const importArea = document.getElementById('import-json-area');
            
            if (!importBtn || !importInput || !importArea) {
                console.error('–≠–ª–µ–º–µ–Ω—Ç—ã –∏–º–ø–æ—Ä—Ç–∞ JSON –Ω–µ –Ω–∞–π–¥–µ–Ω—ã');
                return;
            }
            
            // –ö–ª–∏–∫ –ø–æ –∫–Ω–æ–ø–∫–µ
            importBtn.addEventListener('click', () => {
                importInput.click();
            });
            
            // –í—ã–±–æ—Ä —Ñ–∞–π–ª–∞ —á–µ—Ä–µ–∑ input
            importInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                processJSONFile(file);
            });
            
            // Drag and Drop
            importArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                e.stopPropagation();
                importArea.classList.add('drag-over');
            });
            
            importArea.addEventListener('dragleave', (e) => {
                e.preventDefault();
                e.stopPropagation();
                importArea.classList.remove('drag-over');
            });
            
            importArea.addEventListener('drop', (e) => {
                e.preventDefault();
                e.stopPropagation();
                importArea.classList.remove('drag-over');
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    processJSONFile(files[0]);
                }
            });
        }
        
        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ JSON
        function initSaveJSON() {
            const saveJsonBtn = document.getElementById('save-json-btn');
            if (!saveJsonBtn) {
                console.error('–ö–Ω–æ–ø–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è JSON –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
                return;
            }
            
            saveJsonBtn.addEventListener('click', () => {
            if (!currentProjectId || projectsData.length === 0) {
                showNotification('–ù–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è.', 'warning');
                return;
            }
            
            const currentProject = projectsData.find(p => p.id === currentProjectId);
            if (!currentProject) {
                showNotification('–¢–µ–∫—É—â–∏–π –ø—Ä–æ–µ–∫—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω.', 'error');
                return;
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –ø—Ä–æ–µ–∫—Ç–∞ –∏–∑ —Ç–µ–∫—É—â–∏—Ö —Å–ª–∞–π–¥–æ–≤
            const slides = document.querySelectorAll('.slide');
            const updatedSlides = [];
            
            slides.forEach((slide, index) => {
                const bgData = extractColorsFromBackground(slide.style.background);
                const slideData = {
                    id: index + 1,
                    background: bgData,
                    emoji: null,
                    title: null,
                    subtitle: null,
                    paragraph: null,
                    images: [],
                    cta: null
                };
                
                // –≠–º–æ–¥–∂–∏
                const emojiEl = slide.querySelector('.emoji');
                if (emojiEl) {
                    slideData.emoji = emojiEl.textContent.trim();
                }
                
                // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ —Ü–≤–µ—Ç–∞ –≤ HEX
                const rgbToHex = (rgb) => {
                    if (!rgb || rgb === 'transparent') return '#ffffff';
                    if (rgb.startsWith('#')) return rgb;
                    if (rgb.startsWith('rgb')) {
                        const matches = rgb.match(/\d+/g);
                        if (matches && matches.length >= 3) {
                            return '#' + matches.map(x => {
                                const hex = parseInt(x).toString(16);
                                return hex.length === 1 ? '0' + hex : hex;
                            }).join('');
                        }
                    }
                    return '#ffffff';
                };
                
                // –ó–∞–≥–æ–ª–æ–≤–æ–∫
                const titleEl = slide.querySelector('h1') || slide.querySelector('h2');
                if (titleEl) {
                    const computedStyle = window.getComputedStyle(titleEl);
                    slideData.title = {
                        text: titleEl.innerText,
                        tag: titleEl.tagName.toLowerCase(),
                        style: {
                            fontFamily: computedStyle.fontFamily || null,
                            fontSize: computedStyle.fontSize || null,
                            textAlign: computedStyle.textAlign || null,
                            color: rgbToHex(computedStyle.color)
                        }
                    };
                }
                
                // –ü–æ–¥–∑–∞–≥–æ–ª–æ–≤–æ–∫
                const subtitleEl = slide.querySelector('.subtitle');
                if (subtitleEl) {
                    const computedStyle = window.getComputedStyle(subtitleEl);
                    slideData.subtitle = {
                        text: subtitleEl.innerText,
                        style: {
                            fontFamily: computedStyle.fontFamily || null,
                            fontSize: computedStyle.fontSize || null,
                            textAlign: computedStyle.textAlign || null,
                            color: rgbToHex(computedStyle.color)
                        }
                    };
                }
                
                // –ü–∞—Ä–∞–≥—Ä–∞—Ñ
                const paragraphEl = slide.querySelector('p');
                if (paragraphEl && !subtitleEl) {
                    const computedStyle = window.getComputedStyle(paragraphEl);
                    slideData.paragraph = {
                        text: paragraphEl.innerText,
                        style: {
                            fontFamily: computedStyle.fontFamily || null,
                            fontSize: computedStyle.fontSize || null,
                            textAlign: computedStyle.textAlign || null,
                            color: rgbToHex(computedStyle.color)
                        }
                    };
                }
                
                // –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
                const imageEls = slide.querySelectorAll('.slide-image');
                imageEls.forEach(img => {
                    const sizeKey = img.dataset.sizeKey;
                    const size = sizeKey ? (imageSizes[sizeKey] || null) : null;
                    slideData.images.push({
                        src: img.src,
                        alt: img.alt || '',
                        size: size
                    });
                });
                
                // –ï—Å–ª–∏ –µ—Å—Ç—å –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è, –¥–æ–±–∞–≤–ª—è–µ–º –∏—Ö
                if (slideImages[index]) {
                    const images = Array.isArray(slideImages[index]) ? slideImages[index] : [slideImages[index]];
                    images.forEach(imgSrc => {
                        const sizeKey = `${index}_${imgSrc.substring(0, 50)}`;
                        const size = imageSizes[sizeKey] || null;
                        slideData.images.push({
                            src: imgSrc,
                            alt: '–ó–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ',
                            size: size
                        });
                    });
                }
                
                // CTA
                const ctaEl = slide.querySelector('.cta');
                if (ctaEl) {
                    slideData.cta = {
                        text: ctaEl.textContent.trim(),
                        color: ctaEl.style.color || null
                    };
                }
                
                updatedSlides.push(slideData);
            });
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–µ–∫—Ç
            currentProject.slides = updatedSlides;
            
            // –§–æ—Ä–º–∏—Ä—É–µ–º JSON –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
            const jsonData = {
                projects: projectsData
            };
            
                // –°–∫–∞—á–∏–≤–∞–µ–º —Ñ–∞–π–ª
                const blob = new Blob([JSON.stringify(jsonData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `project_${currentProjectId}_${Date.now()}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage –ø–æ—Å–ª–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è JSON
                saveToLocalStorage();
                
                showNotification('JSON —Ñ–∞–π–ª —Å–æ—Ö—Ä–∞–Ω—ë–Ω!', 'success');
            });
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è —Ü–≤–µ—Ç–æ–≤ –∏–∑ background
        function extractColorsFromBackground(background) {
            if (!background) return ['#1e3a8a', '#3b82f6'];
            
            if (background.includes('gradient')) {
                // –ò–∑–≤–ª–µ–∫–∞–µ–º –≤—Å–µ hex —Ü–≤–µ—Ç–∞
                const matches = background.match(/#[0-9a-fA-F]{6}/g);
                if (matches && matches.length >= 2) {
                    // –ò–∑–≤–ª–µ–∫–∞–µ–º –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≥—Ä–∞–¥–∏–µ–Ω—Ç–∞
                    const directionMatch = background.match(/(\d+)deg/);
                    const direction = directionMatch ? parseInt(directionMatch[1]) : 135;
                    return {
                        type: 'gradient',
                        colors: matches,
                        direction: direction
                    };
                }
                return {
                    type: 'gradient',
                    colors: ['#1e3a8a', '#3b82f6'],
                    direction: 135
                };
            } else {
                // –°–ø–ª–æ—à–Ω–æ–π —Ü–≤–µ—Ç
                const match = background.match(/#[0-9a-fA-F]{6}/);
                return {
                    type: 'solid',
                    colors: match ? [match[0]] : ['#1e3a8a']
                };
            }
        }
        
        // –≠–∫—Å–ø–æ—Ä—Ç
        function initExport() {
            const exportBtn = document.getElementById('export-btn');
            if (!exportBtn) {
                console.error('–ö–Ω–æ–ø–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
                return;
            }
            
            exportBtn.addEventListener('click', async () => {
                const need1 = document.getElementById('export-1-1').checked;
                const need916 = document.getElementById('export-9-16').checked;
            
            if (!need1 && !need916) {
                showNotification('–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω —Ñ–æ—Ä–º–∞—Ç –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞.', 'warning');
                return;
            }
            
            try {
                if (!window.showDirectoryPicker) {
                    showNotification('–í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≤—ã–±–æ—Ä –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ Chrome –∏–ª–∏ Edge.', 'warning');
                    return;
                }
                
                const dir = await window.showDirectoryPicker();
                const slidesList = Array.from(document.querySelectorAll('.slide'));
                let created = 0;
                
                for (let i = 0; i < slidesList.length; i++) {
                    const node = slidesList[i];
                    const is9 = node.classList.contains('format-9-16');
                    const exportThis = is9 ? need916 : need1;
                    
                    if (!exportThis) continue;
                    
                    const titleEl = node.querySelector('h1') || node.querySelector('h2');
                    const title = titleEl ? titleEl.innerText.trim().replace(/\n/g, ' ') : `–°–ª–∞–π–¥_${i+1}`;
                    const slug = title.normalize('NFKD').replace(/[^\w\u0400-\u04FF\s-]/g, '').trim().replace(/\s+/g, '_');
                    const two = String(i + 1).padStart(2, '0');
                    const filename = `${two}_${slug}.txt`;
                    const formats = [];
                    if (need1) formats.push('1:1');
                    if (need916) formats.push('9:16');
                    const content = `–§–æ—Ä–º–∞—Ç—ã: ${formats.join(', ')}\n${title}`;
                    
                    const handle = await dir.getFileHandle(filename, { create: true });
                    const w = await handle.createWritable();
                    await w.write(content);
                    await w.close();
                    created++;
                }
                
                showNotification(`–≠–∫—Å–ø–æ—Ä—Ç –∑–∞–≤–µ—Ä—à—ë–Ω. –°–æ–∑–¥–∞–Ω–æ —Ñ–∞–π–ª–æ–≤: ${created}`, 'success');
            } catch (e) {
                if (e.name !== 'AbortError') {
                    showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ —ç–∫—Å–ø–æ—Ä—Ç–µ: ' + e.message, 'error');
                    console.error(e);
                }
            }
            });
        }
        
    </script>
</head>
<body>
    <!-- –ü–∞–Ω–µ–ª—å –ø—Ä–æ–µ–∫—Ç–æ–≤ —Å–ª–µ–≤–∞ -->
    <div id="projects-panel" class="projects-panel">
        <h3>–ü—Ä–æ–µ–∫—Ç—ã</h3>
        <div id="projects-list"></div>
        <div id="import-json-area" class="import-json-area">
            <input type="file" id="import-json-input" accept=".json" style="display: none;">
            <button id="import-json-btn" class="import-btn">–ò–º–ø–æ—Ä—Ç JSON</button>
            <div class="drag-drop-hint">–∏–ª–∏ –ø–µ—Ä–µ—Ç–∞—â–∏—Ç–µ JSON —Ñ–∞–π–ª —Å—é–¥–∞</div>
        </div>
    </div>
    
    <div class="format-toggle">
        <button class="format-btn active" data-format="1-1">1:1</button>
        <button class="format-btn" data-format="9-16">9:16</button>
    </div>
    <div id="export-controls" class="export-controls">
        <button id="export-btn" class="export-btn">–≠–∫—Å–ø–æ—Ä—Ç</button>
        <button id="save-json-btn" class="export-btn" style="background: #10b981;">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å JSON</button>
        <label class="export-checkbox">
            <input type="checkbox" id="export-1-1" checked> 1:1
        </label>
        <label class="export-checkbox">
            <input type="checkbox" id="export-9-16" checked> 9:16
        </label>
        <label class="export-checkbox" style="margin-left: 15px; padding-left: 15px; border-left: 1px solid rgba(255,255,255,0.3);">
            <input type="checkbox" id="preview-both"> –ü—Ä–µ–≤—å—é –æ–±–∞ —Ñ–æ—Ä–º–∞—Ç–∞
        </label>
    </div>
    
    <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Å–ª–∞–π–¥–æ–≤ -->
    <div id="slides-container"></div>
</body>
</html>